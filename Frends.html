<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìºë¦­í„° í‚¤ìš°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            background-color: #FFFBEB;
            touch-action: manipulation;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100vh;
        }

        .screen.active {
            display: flex;
        }

        .gradient-bg {
            background: radial-gradient(circle at top, #FDE68A 0%, #F97316 40%, #7C2D12 100%);
        }

        .btn-main {
            background: linear-gradient(135deg, #34D399, #059669);
        }

        .btn-main:hover {
            background: linear-gradient(135deg, #6EE7B7, #10B981);
        }

        .btn-sub {
            background: linear-gradient(135deg, #60A5FA, #2563EB);
        }

        .btn-sub:hover {
            background: linear-gradient(135deg, #93C5FD, #3B82F6);
        }

        .btn-warn {
            background: linear-gradient(135deg, #FB923C, #EA580C);
        }

        .btn-warn:hover {
            background: linear-gradient(135deg, #FDBA74, #F97316);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .pixel-border {
            box-shadow:
                    0 0 0 4px #1F2933,
                    0 0 0 8px #FCD34D;
        }

        .shadow-soft {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
        }

        .icon-bounce {
            animation: bounce 1.2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .poop-float {
            animation: poopFloat 2.5s infinite;
        }

        @keyframes poopFloat {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* ê²Œì´ì§€ ë°” ìŠ¤íƒ€ì¼ */
        .bar-container {
            background: #E5E7EB;
            border-radius: 999px;
            overflow: hidden;
            border: 2px solid #374151;
        }

        /* ë˜¥ ì´ë¯¸ì§€ */
        .poop {
            position: absolute;
            font-size: 3rem;
        }

        /* ìŠ¤í¬ë¡¤ ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ì—ì„œ ì‚´ì§ ì—¬ë°±) */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* ë©”ì¸ ê²Œì„ ë©í¼ë¥¼ ìŠ¤í¬ë¡¤ ì˜ì—­ìœ¼ë¡œ */
        #app-root {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-yellow-50">
<div id="app-root" class="flex items-center justify-center">

    <!-- 1. ì‹œì‘ í™”ë©´ -->
    <div id="start-screen" class="screen active gradient-bg items-center justify-center">
        <div class="max-w-md w-full mx-4 bg-white/90 rounded-3xl p-6 pixel-border shadow-soft">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-2 text-yellow-600 drop-shadow-sm">
                ìºë¦­í„° í‚¤ìš°ê¸°
            </h1>
            <p class="text-center text-gray-700 mb-6">
                ë‚˜ë§Œì˜ í”½ì…€ ìºë¦­í„°ë¥¼ ë§Œë“¤ê³ <br>í€´ì¦ˆë¡œ í‚¤ì›Œ ë³´ì•„ìš”!
            </p>

            <div class="bg-yellow-100 rounded-2xl p-4 mb-4">
                <h2 class="text-xl font-bold mb-2 text-yellow-800 flex items-center gap-2">
                    <i class="fas fa-user-graduate text-yellow-600"></i> ë‚´ ì •ë³´
                </h2>
                <label class="block text-sm mb-1 text-gray-700">ë‚´ ë²ˆí˜¸</label>
                <input id="student-number" type="number" min="1" max="99"
                       class="w-full mb-3 p-2 rounded-lg border-2 border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                       placeholder="ì˜ˆ: 12">

                <label class="block text-sm mb-1 text-gray-700">í« ì´ë¦„</label>
                <input id="pet-name" type="text"
                       class="w-full mb-3 p-2 rounded-lg border-2 border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                       placeholder="ì˜ˆ: ë³µìŠ¬ì´">
            </div>

            <button onclick="startGame()"
                    class="w-full btn-main text-white font-bold py-3 rounded-2xl text-lg shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-play icon-bounce"></i>
                ì‹œì‘í•˜ê¸°
            </button>

            <p class="mt-4 text-xs text-gray-500 text-center">
               ìì‹ ì˜ ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì ì–´ ì£¼ì„¸ìš”.
            </p>
        </div>
    </div>

    <!-- 2. ë©”ì¸ ê²Œì„ í™”ë©´ -->
    <div id="main-screen" class="screen gradient-bg flex-col">

        <!-- ìƒë‹¨ ìƒíƒœ ë°” -->
        <div class="w-full px-4 pt-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="fas fa-ghost text-2xl"></i>
                </div>
                <div>
                    <div class="text-sm opacity-80">ë‚˜ì˜ í«</div>
                    <div id="ui-name" class="font-bold text-lg">ì´ë¦„</div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-1 text-sm">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-1 rounded-full bg-black/30 text-xs">Lv.<span id="ui-level">1</span></span>
                    <span class="px-2 py-1 rounded-full bg-yellow-300 text-black flex items-center gap-1">
                            <i class="fas fa-candy-cane"></i>
                            <span id="ui-candy">0</span>
                        </span>
                </div>
                <button onclick="openSettings()"
                        class="text-xs underline text-yellow-100">
                    ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ì¤‘ì•™ í« ì˜ì—­ -->
        <div class="flex-1 flex flex-col items-center justify-center relative px-4">
            <div class="relative w-full max-w-xs bg-white/30 rounded-3xl border-4 border-yellow-200 shadow-inner mt-4">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-400 text-xs px-3 py-1 rounded-full text-black shadow">
                    ìš°ë¦¬ ë°˜ ë†€ì´í„°
                </div>

                <div class="pt-8 pb-4 flex flex-col items-center">
                    <!-- í« ìŠ¤í”„ë¼ì´íŠ¸ -->
                    <div class="w-40 h-40 bg-gradient-to-b from-white/80 to-yellow-100 border-4 border-yellow-300 rounded-3xl flex items-center justify-center shadow-soft mb-3">
                        <img id="pet-image" src="./png/pet_1.png"
                             onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47b.png'; this.style.width='80px';"
                             class="w-32 h-32 object-contain transition-transform duration-200" alt="Pet">
                    </div>

                    <!-- ìƒíƒœ ë§í’ì„  -->
                    <div id="pet-bubble"
                         class="relative bg-white/90 text-gray-800 text-center text-sm px-3 py-2 rounded-2xl shadow-md max-w-[90%]">
                        <div id="pet-status-text">ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ ë†€ ì¤€ë¹„ ë˜ì—ˆì–´!</div>
                        <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-white/90"></div>
                    </div>
                </div>

                <!-- ë˜¥ ì•„ì´ì½˜ ì˜ì—­ -->
                <div id="poop-area" class="absolute bottom-2 left-2 right-2 h-10 pointer-events-none"></div>
            </div>
        </div>

        <!-- í•˜ë‹¨ íŒ¨ë„ -->
        <div class="bg-black/40 backdrop-blur-md rounded-t-3xl px-4 pt-3 pb-4 text-white">
            <!-- ìƒíƒœ ê²Œì´ì§€ -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="flex items-center justify-between mb-1 text-xs">
                        <span class="flex items-center gap-1">
                                <i class="fas fa-drumstick-bite text-yellow-300"></i>
                                ë°°ê³ í””
                            </span>
                        <span id="ui-hunger-text">100%</span>
                    </div>
                    <div class="bar-container h-4">
                        <div id="ui-hunger-bar" class="h-full bg-green-400" style="width: 100%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-1 text-xs">
                        <span class="flex items-center gap-1">
                                <i class="fas fa-soap text-blue-200"></i>
                                ì²­ê²°
                            </span>
                        <span id="ui-clean-text">100%</span>
                    </div>
                    <div class="bar-container h-4">
                        <div id="ui-clean-bar" class="h-full bg-blue-400" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- í–‰ë™ ë²„íŠ¼ -->
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="feedPet()"
                        class="btn-main text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-bowl-food text-xl mb-1"></i>
                    ë°¥ ì£¼ê¸°
                </button>
                <button onclick="playQuiz('korean')"
                        class="btn-sub text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-pen-nib text-xl mb-1"></i>
                    êµ­ì–´ í€´ì¦ˆ
                </button>
                <button onclick="playQuiz('math')"
                        class="btn-sub text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-calculator text-xl mb-1"></i>
                    ìˆ˜í•™ í€´ì¦ˆ
                </button>
            </div>

            <div class="grid grid-cols-3 gap-2">
                <button onclick="cleanPoop()"
                        class="btn-warn text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-toilet text-xl mb-1"></i>
                    ì²­ì†Œí•˜ê¸°
                </button>
                <button onclick="goToBattleSetup()"
                        class="btn-ghost text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-swords text-xl mb-1"></i>
                    ìœ ë ¹ ë°°í‹€
                </button>
                <button onclick="goToCollection()"
                        class="btn-ghost text-white py-2 rounded-2xl text-sm font-bold flex flex-col items-center justify-center">
                    <i class="fas fa-book text-xl mb-1"></i>
                    ë„ê°
                </button>
            </div>
        </div>
    </div>

    <!-- 3. í€´ì¦ˆ í™”ë©´ -->
    <div id="quiz-screen" class="screen bg-gradient-to-b from-indigo-900 to-purple-900 flex-col text-white">
        <div class="w-full px-4 pt-4 flex justify-between items-center">
            <button onclick="endQuiz()" class="text-sm underline">ê·¸ë§Œí•˜ê¸°</button>
            <div class="flex items-center gap-2 text-sm">
                <span class="bg-white/10 px-2 py-1 rounded-full">ì½¤ë³´ <span id="quiz-combo">0</span></span>
                <span class="bg-black/40 px-2 py-1 rounded-full flex items-center gap-1">
                        <i class="fas fa-stopwatch"></i>
                        <span id="quiz-timer">10</span>s
                    </span>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center px-4">
            <div class="bg-white/10 rounded-3xl p-5 max-w-md w-full shadow-soft">
                <div id="quiz-subject-tag"
                     class="inline-block px-3 py-1 rounded-full bg-indigo-500 text-xs mb-3">êµ­ì–´ í€´ì¦ˆ
                </div>
                <div id="quiz-question"
                     class="text-xl md:text-2xl font-bold mb-6 leading-relaxed text-center">
                    ë¬¸ì œ í…ìŠ¤íŠ¸
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button class="quiz-option bg-white/90 text-indigo-900 rounded-2xl py-3 text-lg font-bold shadow"
                            onclick="chooseOption(0)">ë³´ê¸°1
                    </button>
                    <button class="quiz-option bg-white/90 text-indigo-900 rounded-2xl py-3 text-lg font-bold shadow"
                            onclick="chooseOption(1)">ë³´ê¸°2
                    </button>
                    <button class="quiz-option bg-white/90 text-indigo-900 rounded-2xl py-3 text-lg font-bold shadow"
                            onclick="chooseOption(2)">ë³´ê¸°3
                    </button>
                    <button class="quiz-option bg-white/90 text-indigo-900 rounded-2xl py-3 text-lg font-bold shadow"
                            onclick="chooseOption(3)">ë³´ê¸°4
                    </button>
                </div>

                <div id="quiz-feedback"
                     class="mt-4 text-3xl text-center min-h-[2rem] transition-all duration-200"></div>
            </div>
        </div>
    </div>

    <!-- 5. ë°°í‹€ ì¤€ë¹„ (QR + ë²ˆí˜¸) -->
    <div id="battle-setup-screen" class="screen bg-purple-900 text-white p-6 items-center justify-center">
        <h2 class="text-3xl font-bold mb-4">ì¹œêµ¬ ì°¾ê¸°</h2>
        <div class="bg-purple-800 p-6 rounded-2xl w-full max-w-sm text-center border-4 border-purple-600 mb-6">
            <i class="fas fa-qrcode text-9xl mb-4 text-white opacity-80"></i>
            <p class="mb-2">ì¹œêµ¬ì˜ QRì½”ë“œë¥¼ ì°ê±°ë‚˜<br>ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”</p>

            <input type="file" id="qr-file-input"
                   accept="image/*"
                   capture="environment"
                   class="w-full text-xs text-purple-100 mb-3 bg-purple-900 rounded px-2 py-2 border border-purple-600" />

            <p class="text-xs text-purple-100 mb-2">QRì´ ì˜ ì•ˆ ë˜ë©´ ì•„ë˜ì— ì¹œêµ¬ ë²ˆí˜¸ë¥¼ ì ì–´ë„ ë¼ìš”.</p>

            <input type="number" id="friend-code-input"
                   class="w-full block text-center text-xl p-3 rounded-lg mb-4 text-black"
                   placeholder="ì¹œêµ¬ ë²ˆí˜¸ (ì„ íƒ)">

            <div class="grid grid-cols-3 gap-2">
                <button onclick="scanQrImage()" class="game-btn bg-green-500 hover:bg-green-400 text-black py-3 rounded-lg font-bold border-b-4 border-green-700">
                    QR ì°ê¸°
                </button>
                <button onclick="simulateScan()" class="game-btn bg-blue-400 hover:bg-blue-300 text-black py-3 rounded-lg font-bold border-b-4 border-blue-700">
                    ë²ˆí˜¸ë¡œ ì°¾ê¸°
                </button>
                <button onclick="randomBattle()" class="game-btn bg-yellow-400 hover:bg-yellow-300 font-bold border-b-4 border-yellow-700 text-black py-3 rounded-lg">
                    ì•„ë¬´ë‚˜
                </button>
            </div>
        </div>
        <button onclick="goHome()" class="text-gray-300 underline">ëŒì•„ê°€ê¸°</button>
    </div>

    <!-- 5-1. ë°°í‹€ ì¤€ë¹„ ìƒì„¸ í™”ë©´ -->
    <div id="battle-ready-screen" class="screen bg-purple-950 text-white p-6 items-center justify-center">
        <div class="w-full max-w-md bg-purple-900 rounded-2xl border-4 border-purple-700 p-5">
            <h2 class="text-2xl font-bold mb-4 text-center">ëŒ€ê²° ì¤€ë¹„ ì™„ë£Œ!</h2>
            <div class="grid grid-cols-2 gap-4 items-center mb-4">
                <div class="flex flex-col items-center">
                    <div class="text-sm mb-1 text-purple-200">ë‚˜</div>
                    <img id="ready-my-img" src="./png/pet_1.png"
                         onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47b.png'; this.style.width='72px';"
                         class="w-20 h-20 object-contain mb-1">
                    <div class="text-sm">
                        <span class="bg-blue-500 px-2 rounded-full text-xs mr-1">
                            Lv.<span id="ready-my-level">1</span>
                        </span>
                    </div>
                    <div id="ready-my-name" class="font-bold mt-1">ë‚´ í«</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-sm mb-1 text-purple-200">ì¹œêµ¬</div>
                    <img id="ready-enemy-img" src="./png/pet_2.png"
                         onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47b.png'; this.style.width='72px';"
                         class="w-20 h-20 object-contain mb-1">
                    <div class="text-sm">
                        <span class="bg-red-500 px-2 rounded-full text-xs mr-1">
                            Lv.<span id="ready-enemy-level">1</span>
                        </span>
                    </div>
                    <div id="ready-enemy-name" class="font-bold mt-1">ì¹œêµ¬ í«</div>
                </div>
            </div>
            <p class="text-center text-sm text-purple-100 mb-4">ì´ ì¹œêµ¬ì™€ ë°°í‹€ì„ ì‹œì‘í• ê¹Œìš”?</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="confirmBattle()" class="game-btn bg-yellow-400 hover:bg-yellow-300 text-black py-3 rounded-lg font-bold border-b-4 border-yellow-700">
                    ë°°í‹€ ì‹œì‘!
                </button>
                <button onclick="cancelBattleReady()" class="game-btn bg-gray-500 hover:bg-gray-400 py-3 rounded-lg font-bold border-b-4 border-gray-700">
                    ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- 6. ë°°í‹€ í™”ë©´ -->
    <div id="battle-screen" class="screen bg-gray-800 relative overflow-hidden">
        <!-- ë°°ê²½ ì¥ì‹ -->
        <div class="absolute w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]"></div>

        <!-- ìƒë‹¨: ì  -->
        <div class="flex flex-col items-center mt-8 z-10">
            <div class="flex items-center gap-2 text-white mb-1">
                <span class="bg-red-500 px-2 rounded font-bold text-sm">Lv.<span id="enemy-level">?</span></span>
                <span id="enemy-name" class="font-bold text-lg">ì¹œêµ¬ í«</span>
            </div>
            <div class="bar-container w-48 h-4 bg-gray-700">
                <div id="enemy-hp-bar" class="bg-red-500 h-full transition-all duration-300" style="width: 100%"></div>
            </div>
            <img id="enemy-pet-img" src="./png/pet_2.png"
                 onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47b.png'; this.style.width='72px';"
                 class="w-32 h-32 mt-4 object-contain transition-transform duration-100" alt="Enemy">
        </div>

        <!-- VS -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
            <span class="text-6xl font-black text-yellow-500 italic drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)]">VS</span>
        </div>

        <!-- í•˜ë‹¨: ë‚˜ -->
        <div class="flex flex-col items-center mb-8 mt-auto z-10">
            <img id="my-battle-img" src="./png/pet_1.png"
                 onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47b.png'; this.style.width='72px';"
                 class="w-32 h-32 mb-4 object-contain transition-transform duration-100" alt="Me">
            <div class="bar-container w-48 h-4 bg-gray-700">
                <div id="my-hp-bar" class="bg-green-500 h-full transition-all duration-300" style="width: 100%"></div>
            </div>
            <div class="flex items-center gap-2 text-white mt-1">
                <span class="bg-blue-500 px-2 rounded font-bold text-sm">Lv.<span id="my-battle-level">?</span></span>
                <span id="my-battle-name" class="font-bold text-lg">ë‚´ í«</span>
            </div>
        </div>

        <!-- ë©”ì‹œì§€ -->
        <div id="battle-message"
             class="absolute bottom-1/2 transform translate-y-1/2 left-1/2 -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-2xl text-xl font-bold drop-shadow-md z-30 opacity-0 transition-opacity">
            ì „íˆ¬ ì‹œì‘!
        </div>

        <!-- ìŠ¤í‚µ ë²„íŠ¼ -->
        <button onclick="skipBattle()" class="absolute top-4 right-4 bg-black/60 text-white px-3 py-1 rounded text-sm z-50">ê²°ê³¼ ë³´ê¸° >></button>
    </div>

    <!-- 7. ë°°í‹€ ê²°ê³¼ -->
    <div id="battle-result-screen" class="screen bg-black bg-opacity-80 fixed inset-0 z-50 justify-center items-center text-white text-center">
        <h2 id="result-title" class="text-5xl font-bold mb-4 text-yellow-400">ìŠ¹ë¦¬!</h2>
        <p id="result-detail" class="mb-4 text-xl">ì•„ìŠ¬ì•„ìŠ¬í•˜ê²Œ ì´ê²¼ì–´ìš”!</p>
        <div id="result-reward" class="mb-8 text-xl">
            <p>ì‚¬íƒ• +3ê°œ</p>
            <p>ê²½í—˜ì¹˜ +10</p>
        </div>
        <button onclick="finishBattle()" class="game-btn bg-white text-black px-8 py-3 rounded-xl font-bold text-xl">
            ì§‘ìœ¼ë¡œ
        </button>
    </div>

    <!-- 8. ë„ê° í™”ë©´ -->
    <div id="collection-screen" class="screen bg-indigo-50 p-6 flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-indigo-800">ì¹œêµ¬ ë„ê°</h2>
            <button onclick="goHome()" class="bg-gray-300 px-3 py-1 rounded font-bold text-gray-700">ë‹«ê¸°</button>
        </div>

        <div id="collection-list" class="grid grid-cols-2 gap-3 overflow-y-auto max-h-[70vh] pr-1">
            <!-- ì¹œêµ¬ ì¹´ë“œë“¤ -->
        </div>
    </div>
</div>

<script>
    // ===================== ì „ì—­ ìƒíƒœ =====================
    let gameState = {
        player: {
            name: "",
            number: 1,
            level: 1,
            exp: 0,
            hunger: 100,
            cleanliness: 100,
            candies: 0,
            maxHp: 30,
            attack: 5,
            poops: 0,
            characterId: 1,
            lastPoopId: 0
        },
        collection: [],
        lastTickTime: Date.now()
    };

    const LEVEL_EXP_BASE = 20;
    const LEVEL_EXP_INC = 5;

    // ì´ˆê¸°í™”
    window.onload = function() {
        loadGame();
    };

    function saveGame() {
        gameState.lastTickTime = Date.now();
        localStorage.setItem('myPetSchoolData', JSON.stringify(gameState));
    }

    function loadGame() {
        const data = localStorage.getItem('myPetSchoolData');
        if (data) {
            const parsed = JSON.parse(data);
            // ê¸°ì¡´ ë°ì´í„°ì™€ êµ¬ì¡° ë³‘í•© (ì—…ë°ì´íŠ¸ ëŒ€ë¹„)
            gameState = { ...gameState, ...parsed, player: { ...gameState.player, ...parsed.player } };

            // ì‹œê°„ ê²½ê³¼ ê³„ì‚°
            calculateOfflineProgress();

            if (gameState.player.name) {
                showScreen('main-screen');
                startGameLoop();
            } else {
                showScreen('start-screen');
            }
        } else {
            showScreen('start-screen');
        }
        updateUI();
    }

    function calculateOfflineProgress() {
        const now = Date.now();
        const diffMs = now - gameState.lastTickTime;
        const diffMinutes = Math.floor(diffMs / 60000);

        if (diffMinutes > 0) {
            // 30ë¶„ë§ˆë‹¤ ë°°ê³ í”” -10
            const hungerDrop = Math.floor(diffMinutes / 30) * 10;
            gameState.player.hunger = Math.max(0, gameState.player.hunger - hungerDrop);

            // 60ë¶„ë§ˆë‹¤ ì²­ê²° -10, ë˜¥ í™•ë¥ 
            const hours = Math.floor(diffMinutes / 60);
            const cleanDrop = hours * 10;
            gameState.player.cleanliness = Math.max(0, gameState.player.cleanliness - cleanDrop);

            // ì‹œê°„ ê²½ê³¼ ë™ì•ˆ ëœë¤ ë˜¥ (ê°„ë‹¨ ëª¨ë¸)
            const poopCount = Math.floor(diffMinutes / 90); // 1.5ì‹œê°„ë§ˆë‹¤ 1íšŒ
            gameState.player.poops = Math.min(5, gameState.player.poops + poopCount);
        }
    }

    // ===================== ì‹œì‘/ë©”ì¸ =====================
    function startGame() {
        const num = document.getElementById('student-number').value;
        const name = document.getElementById('pet-name').value;

        if (!num || !name) {
            alert('ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì ì–´ì£¼ì„¸ìš”!');
            return;
        }

        gameState.player.number = Number(num);
        gameState.player.name = name;
        // ë²ˆí˜¸ ê·¸ëŒ€ë¡œ ìºë¦­í„° ì´ë¯¸ì§€ ë²ˆí˜¸ë¡œ ì‚¬ìš© (êµì‚¬ê°€ ë²ˆí˜¸ë³„ PNGë¥¼ ë¯¸ë¦¬ ë„£ì–´ë‘”ë‹¤ê³  ê°€ì •)
        gameState.player.characterId = Number(num);

        saveGame();
        showScreen('main-screen');
        startGameLoop();
        updateUI();
    }

    function startGameLoop() {
        setInterval(() => {
            const p = gameState.player;

            // ë°°ê³ í””/ì²­ê²° ìì—° ê°ì†Œ
            p.hunger = Math.max(0, p.hunger - 0.05);      // ì²œì²œíˆ ê°ì†Œ
            p.cleanliness = Math.max(0, p.cleanliness - 0.03);

            // ì¼ì • í™•ë¥ ë¡œ ë˜¥ ìƒì„±
            if (Math.random() < 0.002 && p.poops < 5) {
                p.poops++;
            }

            updateUI();
        }, 1000);
    }

    function updateUI() {
        const p = gameState.player;
        document.getElementById('ui-level').innerText = p.level;
        document.getElementById('ui-name').innerText = p.name;
        document.getElementById('ui-candy').innerText = p.candies;

        // ê²½í—˜ì¹˜
        const reqExp = LEVEL_EXP_BASE + (p.level - 1) * LEVEL_EXP_INC;
        const expPct = (p.exp / reqExp) * 100;
        const expText = `${p.exp} / ${reqExp}`;
        // (ê²½í—˜ì¹˜ ë°”ë¥¼ ë”°ë¡œ ë§Œë“¤ ìˆ˜ë„ ìˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í…ìŠ¤íŠ¸ë¡œë§Œ ìœ ì§€)

        // ìƒíƒœë°”
        document.getElementById('ui-hunger-bar').style.width = `${p.hunger}%`;
        document.getElementById('ui-clean-bar').style.width = `${p.cleanliness}%`;

        // ë©”ì¸ í« ì´ë¯¸ì§€ (ë²ˆí˜¸ë³„ PNG ë§¤í•‘)
        const mainPetImg = document.getElementById('pet-image');
        if (mainPetImg) {
            mainPetImg.src = `./png/pet_${p.characterId}.png`;
        }

        document.getElementById('ui-hunger-text').innerText = `${Math.round(p.hunger)}%`;
        document.getElementById('ui-clean-text').innerText = `${Math.round(p.cleanliness)}%`;

        // ë˜¥ UI
        renderPoops();

        // ë§í’ì„  ìƒíƒœ
        const bubble = document.getElementById('pet-status-text');
        if (p.hunger < 30) {
            bubble.innerText = 'ë°°ê³ íŒŒ... ë°¥ ë¨¹ê³  ì‹¶ì–´!';
        } else if (p.cleanliness < 40) {
            bubble.innerText = 'ë”ëŸ¬ì›Œ... ì²­ì†Œí•´ì¤˜!';
        } else if (p.level >= 5) {
            bubble.innerText = 'ë‚˜, ë§ì´ ê°•í•´ì§„ ê²ƒ ê°™ì•„!';
        } else {
            bubble.innerText = 'ì˜¤ëŠ˜ë„ ì¦ê²ê²Œ ë†€ì!';
        }
    }

    function renderPoops() {
        const area = document.getElementById('poop-area');
        area.innerHTML = '';
        const count = gameState.player.poops;
        for (let i = 0; i < count; i++) {
            const span = document.createElement('span');
            span.className = 'poop poop-float';
            span.style.left = `${10 + i * 15}%`;
            span.innerText = 'ğŸ’©';
            area.appendChild(span);
        }
    }

    // ===================== ê¸°ë³¸ í–‰ë™ =====================
    function feedPet() {
        if (gameState.player.candies <= 0 && gameState.player.hunger > 80) {
            alert('ì§€ê¸ˆì€ ë°°ê°€ ë³„ë¡œ ì•ˆ ê³ íŒŒìš”.');
            return;
        }
        gameState.player.hunger = Math.min(100, gameState.player.hunger + 25);
        gameState.player.cleanliness = Math.max(0, gameState.player.cleanliness - 5);

        // ê°„ë‹¨í•œ ë³´ìƒ
        if (gameState.player.hunger > 90) {
            addExp(3);
        }

        saveGame();
        updateUI();

        // ë¨¹ëŠ” ì—°ì¶œ
        const img = document.getElementById('pet-image');
        img.style.transform = "scale(1.2)";
        setTimeout(() => img.style.transform = "scale(1)", 200);
    }

    function cleanPoop() {
        if (gameState.player.poops === 0 && gameState.player.cleanliness >= 90) {
            alert('ì´ë¯¸ ê¹¨ë—í•´ìš”!');
            return;
        }

        if (gameState.player.poops > 0) {
            // ë˜¥ ì¹˜ìš°ê¸°
            gameState.player.poops = 0;
            addExp(2); // ì²­ì†Œ ë³´ìƒ
        }
        gameState.player.cleanliness = 100;

        saveGame();
        updateUI();
        renderPoops();

        // ë°˜ì§ ì´í™íŠ¸
        const area = document.getElementById('poop-area');
        area.innerHTML = '';
    }

    function addExp(amount) {
        const p = gameState.player;
        p.exp += amount;

        const reqExp = LEVEL_EXP_BASE + (p.level - 1) * LEVEL_EXP_INC;
        if (p.exp >= reqExp) {
            p.exp -= reqExp;
            p.level += 1;
            p.maxHp += 5;
            p.attack += 1;
            // ë ˆë²¨ì—… íš¨ê³¼
            alert(`ë ˆë²¨ ì—…! ì´ì œ Lv.${p.level}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }
        saveGame();
        updateUI();
    }

    // ===================== í€´ì¦ˆ ì‹œìŠ¤í…œ =====================
    let currentSubject = 'korean';
    let quizAnswer = null;
    let quizTimer = null;
    let combo = 0;

    function playQuiz(subject) {
        currentSubject = subject;
        combo = 0;
        document.getElementById('quiz-combo').innerText = '0';
        document.getElementById('quiz-subject-tag').innerText = subject === 'korean' ? 'êµ­ì–´ í€´ì¦ˆ' : 'ìˆ˜í•™ í€´ì¦ˆ';
        showScreen('quiz-screen');
        nextQuestion();
    }

    function nextQuestion() {
        // 10ì´ˆ ì œí•œ
        if (quizTimer) clearInterval(quizTimer);
        let timeLeft = 10;
        document.getElementById('quiz-timer').innerText = timeLeft;
        quizTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('quiz-timer').innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(quizTimer);
                // ì‹œê°„ ì´ˆê³¼ = ì˜¤ë‹µ ì²˜ë¦¬
                handleAnswer(-1);
            }
        }, 1000);

        const qDiv = document.getElementById('quiz-question');
        const buttons = document.querySelectorAll('.quiz-option');

        let questionText = "";
        let answer = 0;
        let options = [];

        if (currentSubject === 'math') {
            // 1í•™ë…„ ìˆ˜ì¤€: í•œ ìë¦¬ìˆ˜ ë§ì…ˆ/ëº„ì…ˆ
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;

            if (Math.random() > 0.5) {
                questionText = `${a} + ${b} = ?`;
                answer = a + b;
            } else {
                const max = Math.max(a, b);
                const min = Math.min(a, b);
                questionText = `${max} - ${min} = ?`;
                answer = max - min;
            }

            options = [answer, answer + 1, answer - 1, answer + 2];
            // ì„ê¸°
            options.sort(() => Math.random() - 0.5);

            // ì¤‘ë³µ ì œê±° ë° ë¶€ì¡±ì‹œ ì±„ìš°ê¸° (ê°„ë‹¨í™”)
            options = [...new Set(options)];
            while(options.length < 4) options.push(options[0] + Math.floor(Math.random()*5)+1);

            qDiv.innerText = questionText;

        } else {
            // êµ­ì–´: ì´ˆì„± í€´ì¦ˆ(ì•„ì£¼ ë‹¨ìˆœ ë²„ì „)
            const words = [
                { full: "í•™êµ", hint: "ã…ã„±" },
                { full: "ì‚¬ê³¼", hint: "ã……ã„±" },
                { full: "ì—°í•„", hint: "ã…‡ã…" },
                { full: "ì±…ìƒ", hint: "ã…Šã……" },
                { full: "ìë™ì°¨", hint: "ã…ˆã„·ã…Š" },
                { full: "ê³ ì–‘ì´", hint: "ã„±ã…‡ã…‡" },
                { full: "ê°•ì•„ì§€", hint: "ã„±ã…‡ã…ˆ" }
            ];
            const pick = words[Math.floor(Math.random() * words.length)];
            questionText = `ë‹¤ìŒ ì´ˆì„±ì— ë§ëŠ” ë§ì„ ê³ ë¥´ì„¸ìš”: ${pick.hint}`;
            answer = pick.full;

            const others = words
                .filter(w => w.full !== pick.full)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(w => w.full);

            options = [answer, ...others];
            options.sort(() => Math.random() - 0.5);

            qDiv.innerText = questionText;
        }

        quizAnswer = answer;

        buttons.forEach((btn, idx) => {
            btn.innerText = options[idx];
            btn.dataset.value = options[idx];
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        });

        document.getElementById('quiz-feedback').innerText = "";
    }

    function chooseOption(idx) {
        const buttons = document.querySelectorAll('.quiz-option');
        const value = buttons[idx].dataset.value;
        handleAnswer(value);
    }

    function handleAnswer(value) {
        const buttons = document.querySelectorAll('.quiz-option');
        buttons.forEach(btn => btn.disabled = true);

        clearInterval(quizTimer);

        const correct = String(value) === String(quizAnswer);

        if (correct) {
            combo++;
            showFeedback('â­•ï¸');
            // ì½¤ë³´ì— ë”°ë¼ ê²½í—˜ì¹˜ ì¦ê°€
            let expGain = 5 + (combo > 1 ? combo : 0);
            addExp(expGain);

            // 3ì½¤ë³´ë§ˆë‹¤ ì‚¬íƒ• 1ê°œ
            if (combo % 3 === 0) {
                gameState.player.candies++;
                // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒëµ, UI ì—…ë°ì´íŠ¸ë§Œ
            }

            document.getElementById('quiz-combo').innerText = combo;

            // 5ì½¤ë³´ ë‹¬ì„± ì‹œ ì´í™íŠ¸
            if(combo === 5) alert("5ì½¤ë³´ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!");

            setTimeout(nextQuestion, 800);
        } else {
            combo = 0;
            document.getElementById('quiz-combo').innerText = '0';
            showFeedback('âŒ');
            setTimeout(nextQuestion, 1000);
        }
    }

    function showFeedback(emoji) {
        const el = document.getElementById('quiz-feedback');
        el.innerText = emoji;
        el.style.opacity = 1;
        el.style.transform = "translate(-50%, -50%) scale(1.5)";
        setTimeout(() => {
            el.style.opacity = 0;
            el.style.transform = "translate(-50%, -50%) scale(0.5)";
        }, 500);
    }

    function endQuiz() {
        clearInterval(quizTimer);
        showScreen('main-screen');
        updateUI();
    }


    /* --- 5. ë°°í‹€ ì‹œìŠ¤í…œ --- */
    let battleState = {
        me: {},
        enemy: {},
        log: [],
        turn: 0,
        pendingEnemy: null
    };

    function goToBattleSetup() {
        showScreen('battle-setup-screen');
    }

    // ë°°í‹€ ì¤€ë¹„ í™”ë©´ìœ¼ë¡œ ì´ë™ (QR/ë²ˆí˜¸/ëœë¤ ëª¨ë‘ ì´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©)
    function enterBattleReady(enemyData) {
        battleState.pendingEnemy = enemyData;

        const me = gameState.player;

        const myImg = document.getElementById('ready-my-img');
        const enemyImg = document.getElementById('ready-enemy-img');

        if (myImg) {
            myImg.src = `./png/pet_${me.characterId}.png`;
        }
        if (enemyImg) {
            enemyImg.src = `./png/pet_${enemyData.number}.png`;
        }

        const myNameEl = document.getElementById('ready-my-name');
        const myLevelEl = document.getElementById('ready-my-level');
        const enemyNameEl = document.getElementById('ready-enemy-name');
        const enemyLevelEl = document.getElementById('ready-enemy-level');

        if (myNameEl) myNameEl.innerText = me.name || 'ë‚´ í«';
        if (myLevelEl) myLevelEl.innerText = me.level;
        if (enemyNameEl) enemyNameEl.innerText = enemyData.name;
        if (enemyLevelEl) enemyLevelEl.innerText = enemyData.level;

        showScreen('battle-ready-screen');
    }

    function confirmBattle() {
        if (!battleState.pendingEnemy) {
            alert('ëŒ€ê²°í•  ì¹œêµ¬ê°€ ì—†ì–´ìš”. QRì„ ì°ê±°ë‚˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }
        startBattle(battleState.pendingEnemy);
    }

    function cancelBattleReady() {
        battleState.pendingEnemy = null;
        showScreen('battle-setup-screen');
    }

    function randomBattle() {
        // ëœë¤ ì  ìƒì„±
        const levelDiff = Math.floor(Math.random() * 5) - 2; // -2 ~ +2
        const enemyLvl = Math.max(1, gameState.player.level + levelDiff);
        enterBattleReady({
            name: "ì•¼ìƒì˜ í«",
            level: enemyLvl,
            number: 999
        });
    }

    function simulateScan() {
        const input = document.getElementById('friend-code-input').value;
        if (!input) {
            alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ QRì„ ì°ì–´ì£¼ì„¸ìš”.');
            return;
        }
        const num = parseInt(input, 10);
        if (isNaN(num) || num <= 0) {
            alert('ì¹œêµ¬ ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            return;
        }

        // ì‹œë®¬ë ˆì´ì…˜: ì…ë ¥ëœ ë²ˆí˜¸ ê¸°ë°˜ìœ¼ë¡œ ì  ìƒì„± (ë‚´ ë ˆë²¨ Â±2)
        const enemyLvl = Math.max(1, Math.floor(gameState.player.level + (Math.random() * 4 - 2)));
        enterBattleReady({
            name: `ì¹œêµ¬ ${num}`,
            level: enemyLvl,
            number: num
        });
    }

    // QR ì´ë¯¸ì§€ë¡œë¶€í„° ë°ì´í„° ì½ê¸°
    function scanQrImage() {
        const fileInput = document.getElementById('qr-file-input');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('ë¨¼ì € QR ì‚¬ì§„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();
        const img = new Image();

        reader.onload = function (e) {
            img.onload = function () {
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                const code = jsQR(imageData.data, canvas.width, canvas.height);
                if (!code) {
                    alert('QR ì½”ë“œë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ì‚¬ì§„ì„ ë‹¤ì‹œ ì°ì–´ë³¼ê¹Œìš”?');
                    return;
                }
                handleQrPayload(code.data);
            };
            img.src = e.target.result;
        };

        reader.readAsDataURL(file);
    }

    // QR ì•ˆì— ë“¤ì–´ìˆëŠ” í…ìŠ¤íŠ¸ë¥¼ í•´ì„
    function handleQrPayload(data) {
        try {
            // 1) JSON í˜•ì‹ ìš°ì„  ì‹œë„
            const obj = JSON.parse(data);
            if (obj && obj.kind === 'pet-qr' && typeof obj.number !== 'undefined') {
                const num = Number(obj.number);
                const lvl = obj.level ? Number(obj.level) : gameState.player.level;
                const name = obj.name || `ì¹œêµ¬ ${num}`;
                enterBattleReady({
                    name,
                    level: Math.max(1, lvl),
                    number: num
                });
                return;
            }
        } catch (e) {
            // JSONì´ ì•„ë‹ˆë©´ ë¬¸ìì—´ í˜•ì‹ìœ¼ë¡œ í•´ì„
        }

        // 2) "ë²ˆí˜¸:ì´ë¦„:ë ˆë²¨" ê°™ì€ ë‹¨ìˆœ ë¬¸ìì—´ í˜•ì‹ë„ ì§€ì›
        const parts = String(data).split(':');
        if (parts.length >= 1) {
            const num = parseInt(parts[0], 10);
            if (!isNaN(num) && num > 0) {
                const name = parts.length >= 2 && parts[1] ? parts[1] : `ì¹œêµ¬ ${num}`;
                const lvlPart = parts.length >= 3 ? parseInt(parts[2], 10) : gameState.player.level;
                const lvl = isNaN(lvlPart) ? gameState.player.level : lvlPart;

                enterBattleReady({
                    name,
                    level: Math.max(1, lvl),
                    number: num
                });
                return;
            }
        }

        alert('ì•Œ ìˆ˜ ì—†ëŠ” QR í˜•ì‹ì´ì—ìš”. ì„ ìƒë‹˜ê»˜ ì•Œë ¤ ì£¼ì„¸ìš”!');
    }

    function startBattle(enemyData) {
        // ìŠ¤íƒ¯ ê³„ì‚° (ë‚´ í«)
        const myStats = {
            name: gameState.player.name,
            hp: gameState.player.maxHp,
            maxHp: gameState.player.maxHp,
            atk: gameState.player.attack,
            level: gameState.player.level
        };

        // ì  ìŠ¤íƒ¯ ê³„ì‚° (í”Œë ˆì´ì–´ì™€ ë™ì¼ ê³µì‹)
        const enemyMaxHp = 30 + (enemyData.level - 1) * 2;
        const enemyAtk = 5 + (enemyData.level - 1);

        const enemyStats = {
            name: enemyData.name,
            hp: enemyMaxHp,
            maxHp: enemyMaxHp,
            atk: enemyAtk,
            level: enemyData.level,
            id: enemyData.number
        };

        // ë°°í‹€ ìƒíƒœ ì´ˆê¸°í™”
        battleState = {
            me: myStats,
            enemy: enemyStats,
            turn: 0,
            isWin: false,
            pendingEnemy: null
        };

        // ê¸°íš ë¡œì§: ìŠ¹íŒ¨ ë° í„´ìˆ˜ ë¯¸ë¦¬ ê²°ì •
        const levelDiff = myStats.level - enemyStats.level;

        // ìŠ¹ë¥ : ë ˆë²¨ ë†’ìœ¼ë©´ ê±°ì˜ ì´ê¹€
        let winChance = 0.5 + (levelDiff * 0.1);
        if (winChance > 0.9) winChance = 0.9;
        if (winChance < 0.1) winChance = 0.1;

        battleState.isWin = Math.random() < winChance;

        // í„´ ìˆ˜ì™€ ìµœì¢… HP ê²°ì •
        // ì´ê¸°ë©´ ë‚´ ì²´ë ¥ì´ ë‚¨ê³ , ì§€ë©´ ì  ì²´ë ¥ì´ ë‚¨ìŒ
        let turns = 5;
        if (Math.abs(levelDiff) >= 3) turns = 3; // ê²©ì°¨ í¬ë©´ ë¹¨ë¦¬ ëë‚¨
        else if (Math.abs(levelDiff) <= 1) turns = 8; // ë¹„ìŠ·í•˜ë©´ ì˜¤ë˜ ê±¸ë¦¼

        battleState.plan = generateBattlePlan(myStats, enemyStats, battleState.isWin, turns);

        // í™”ë©´ ì„¸íŒ…
        document.getElementById('my-battle-level').innerText = myStats.level;
        document.getElementById('my-battle-name').innerText = myStats.name;
        document.getElementById('enemy-level').innerText = enemyStats.level;
        document.getElementById('enemy-name').innerText = enemyStats.name;

        // ë°°í‹€ìš© ì´ë¯¸ì§€ (ë²ˆí˜¸ë³„ PNG ë§¤í•‘)
        const myBattleImg = document.getElementById('my-battle-img');
        const enemyBattleImg = document.getElementById('enemy-pet-img');
        if (myBattleImg) {
            myBattleImg.src = `./png/pet_${gameState.player.characterId}.png`;
        }
        if (enemyBattleImg) {
            enemyBattleImg.src = `./png/pet_${enemyStats.id}.png`;
        }

        document.getElementById('my-hp-bar').style.width = '100%';
        document.getElementById('enemy-hp-bar').style.width = '100%';
        document.getElementById('battle-result-screen').classList.add('hidden');

        showScreen('battle-screen');

        // ì „íˆ¬ ì‹œì‘
        setTimeout(playNextTurn, 1000);
    }

    function generateBattlePlan(me, enemy, iWin, turns) {
        let plan = [];
        let currentMyHp = me.maxHp;
        let currentEnemyHp = enemy.maxHp;

        let targetMyHp, targetEnemyHp;

        if (iWin) {
            targetEnemyHp = 0;
            targetMyHp = Math.floor(me.maxHp * (0.2 + Math.random() * 0.6)); // 20~80% ë‚¨ìŒ
        } else {
            targetMyHp = 0;
            targetEnemyHp = Math.floor(enemy.maxHp * (0.2 + Math.random() * 0.6));
        }

        // ë°ë¯¸ì§€ ë¶„ë°° (ë‹¨ìˆœí™”: ê· ë“± ë¶„ë°° + ì•½ê°„ì˜ ëœë¤)
        const totalDmgToEnemy = enemy.maxHp - targetEnemyHp;
        const totalDmgToMe = me.maxHp - targetMyHp;

        let dmgToEnemyPerTurn = Math.floor(totalDmgToEnemy / Math.ceil(turns/2));
        let dmgToMePerTurn = Math.floor(totalDmgToMe / Math.floor(turns/2));

        // ë§ˆì§€ë§‰ í„´ì—ì„œ 0 ë§Œë“¤ê¸° ìœ„í•´ ì¡°ì •ì´ í•„ìš”í•˜ì§€ë§Œ, ì—°ì¶œìš©ì´ë¯€ë¡œ ë£¨í”„ ëŒë©° ìƒì„±
        let isMyTurn = true;
        for(let i=0; i<turns; i++) {
            if(isMyTurn) {
                // ë‚´ê°€ ê³µê²©
                let dmg = Math.max(1, Math.floor(dmgToEnemyPerTurn * (0.8 + Math.random()*0.4)));
                currentEnemyHp = Math.max(0, currentEnemyHp - dmg);
                plan.push({attacker: 'me', damage: dmg, myHp: currentMyHp, enemyHp: currentEnemyHp});
            } else {
                // ì ì´ ê³µê²©
                let dmg = Math.max(1, Math.floor(dmgToMePerTurn * (0.8 + Math.random()*0.4)));
                currentMyHp = Math.max(0, currentMyHp - dmg);
                plan.push({attacker: 'enemy', damage: dmg, myHp: currentMyHp, enemyHp: currentEnemyHp});
            }
            isMyTurn = !isMyTurn;
        }

        // ë§ˆì§€ë§‰ í„´ í›„ HP ê°•ì œ ì •ë ¬
        plan[plan.length-1].myHp = targetMyHp;
        plan[plan.length-1].enemyHp = targetEnemyHp;

        return plan;
    }

    function playNextTurn() {
        const msgDiv = document.getElementById('battle-message');

        if (!battleState.plan || battleState.plan.length === 0) {
            // ì „íˆ¬ ì¢…ë£Œ
            showBattleResult();
            return;
        }

        const action = battleState.plan.shift();

        const myBar = document.getElementById('my-hp-bar');
        const enemyBar = document.getElementById('enemy-hp-bar');

        // ë¹„ìœ¨ ê³„ì‚°
        const myPct = (action.myHp / battleState.me.maxHp) * 100;
        const enemyPct = (action.enemyHp / battleState.enemy.maxHp) * 100;

        myBar.style.width = `${myPct}%`;
        enemyBar.style.width = `${enemyPct}%`;

        let text = "";
        if (action.attacker === 'me') {
            text = `${battleState.me.name} ì˜ ê³µê²©!`;
            document.getElementById('my-battle-img').style.transform = "translateX(10px)";
            setTimeout(() => {
                document.getElementById('my-battle-img').style.transform = "translateX(0)";
            }, 200);
        } else {
            text = `${battleState.enemy.name} ì˜ ê³µê²©!`;
            document.getElementById('enemy-pet-img').style.transform = "translateX(-10px)";
            setTimeout(() => {
                document.getElementById('enemy-pet-img').style.transform = "translateX(0)";
            }, 200);
        }

        msgDiv.innerText = text;
        msgDiv.style.opacity = 1;
        setTimeout(() => {
            msgDiv.style.opacity = 0;
        }, 500);

        setTimeout(playNextTurn, 900);
    }

    function showBattleResult() {
        const isWin = battleState.isWin;
        const title = document.getElementById('result-title');
        const detail = document.getElementById('result-detail');
        const reward = document.getElementById('result-reward');

        if (isWin) {
            title.innerText = "ìŠ¹ë¦¬!";
            title.classList.remove('text-red-400');
            title.classList.add('text-yellow-400');
            detail.innerText = "ë©‹ì§€ê²Œ ì´ê²¼ì–´ìš”!";

            // ë³´ìƒ: ì‚¬íƒ• 3ê°œ, ê²½í—˜ì¹˜ 10
            gameState.player.candies += 3;
            addExp(10);
            reward.innerHTML = "<p>ì‚¬íƒ• +3ê°œ</p><p>ê²½í—˜ì¹˜ +10</p>";
        } else {
            title.innerText = "íŒ¨ë°°...";
            title.classList.remove('text-yellow-400');
            title.classList.add('text-red-400');
            detail.innerText = "ì•„ìŠ¬ì•„ìŠ¬í•˜ê²Œ ì¡Œì–´ìš”.";

            // ìœ„ë¡œ ë³´ìƒ: ê²½í—˜ì¹˜ 5
            addExp(5);
            reward.innerHTML = "<p>ê²½í—˜ì¹˜ +5</p>";
        }

        // ë„ê° ë“±ë¡
        addToCollection({
            id: battleState.enemy.id,
            name: battleState.enemy.name,
            level: battleState.enemy.level
        });

        showScreen('battle-result-screen');
    }

    function skipBattle() {
        // ë‚¨ì€ í”Œëœ ë¬´ì‹œí•˜ê³  ê²°ê³¼ë¡œ
        battleState.plan = [];
        showBattleResult();
    }

    function finishBattle() {
        showScreen('main-screen');
        updateUI();
        saveGame();
    }

    function addToCollection(enemy) {
        // ì¤‘ë³µ ì²´í¬ (ë²ˆí˜¸ ê¸°ì¤€)
        const exists = gameState.collection.find(c => c.id === enemy.id);
        if (!exists) {
            gameState.collection.push({
                id: enemy.id,
                name: enemy.name,
                level: enemy.level,
                date: new Date().toLocaleDateString()
            });
        }
    }

    function goToCollection() {
        showScreen('collection-screen');
        const list = document.getElementById('collection-list');
        list.innerHTML = '';

        if (gameState.collection.length === 0) {
            list.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">ì•„ì§ ë§Œë‚œ ì¹œêµ¬ê°€ ì—†ì–´ìš”.<br>ë°°í‹€ì„ í•´ì„œ ì¹œêµ¬ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!</div>';
            return;
        }

        gameState.collection.forEach(friend => {
            const el = document.createElement('div');
            el.className = "bg-white p-3 rounded-xl shadow border border-indigo-100 flex flex-col items-center";

            // ë²ˆí˜¸ë³„ PNG ë§¤í•‘ (idê°€ ì—†ìœ¼ë©´ 1ë¡œ ëŒ€ì²´)
            const imgId = friend.id || friend.number || 1;

            el.innerHTML = `
                    <img src="./png/pet_${imgId}.png"
                         onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png'; this.style.width='60px';"
                         class="w-16 h-16 object-contain mb-2" />
                    <div class="font-bold text-indigo-900">${friend.name}</div>
                    <div class="text-sm text-gray-500">Lv.${friend.level}</div>
                `;
            list.appendChild(el);
        });
    }

    /* --- ìœ í‹¸ë¦¬í‹° --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none'; // flex ë„ê¸°
        });
        const target = document.getElementById(id);
        target.classList.add('active');
        target.style.display = 'flex';
    }

    function goHome() {
        showScreen('main-screen');
        updateUI();
    }

    function openSettings() {
        if(confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ í• ê¹Œìš”? (ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì ¸ìš”)')) {
            localStorage.removeItem('myPetSchoolData');
            location.reload();
        }
    }

</script>
</body>
</html>
