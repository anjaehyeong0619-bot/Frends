<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ í•™êµ í« í‚¤ìš°ê¸° V3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            background-color: #FFFBEB;
            touch-action: manipulation;
            user-select: none;
        }

        .screen {
            display: none;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }

        .active {
            display: flex;
        }

        /* í« ì´ë¯¸ì§€ ì• ë‹ˆë©”ì´ì…˜ */
        .pet-bounce {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ì½¤ë³´ ì´í™íŠ¸ */
        .combo-text {
            position: absolute;
            font-size: 2rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
            animation: popUp 0.5s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes popUp {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        /* ë°°í‹€ ë°ë¯¸ì§€ */
        .damage-text {
            position: absolute;
            font-size: 1.5rem;
            color: #EF4444;
            font-weight: bold;
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* í”½ì…€ ì•„íŠ¸ ì´ë¯¸ì§€ ì„ ëª…í•˜ê²Œ í‘œì‹œ */
        .pixel-art {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
        }

        /* ê²Œì´ì§€ ë°” ìŠ¤íƒ€ì¼ */
        .bar-container {
            background: #E5E7EB;
            border-radius: 999px;
            overflow: hidden;
            border: 2px solid #374151;
        }

        /* ë˜¥ ì´ë¯¸ì§€ */
        .poop {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .poop:active {
            transform: scale(0.8);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .game-btn {
            transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .game-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.2);
        }

        /* íŒŒì¼ ì¸í’‹ ìˆ¨ê¸°ê¸° (ì»¤ìŠ¤í…€ ë²„íŠ¼ ì—°ê²°ìš©) */
        #qr-file-input {
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">

<div id="start-screen" class="screen active justify-center items-center bg-yellow-100 p-6">
    <h1 class="text-4xl text-orange-500 mb-8 text-center drop-shadow-md">
        <i class="fas fa-paw"></i> ìš°ë¦¬ í•™êµ<br>í« í‚¤ìš°ê¸° V3.1
    </h1>
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center border-4 border-orange-300">
        <p class="mb-4 text-xl">ìê¸° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”!</p>
        <input type="number" id="student-number" class="w-full text-center text-3xl p-3 border-b-4 border-orange-200 focus:outline-none mb-4 rounded-lg bg-orange-50" placeholder="ë²ˆí˜¸ (ì˜ˆ: 15)">
        <p class="mb-2 text-lg">í«ì˜ ì´ë¦„ì€?</p>
        <input type="text" id="pet-name" class="w-full text-center text-2xl p-3 border-b-4 border-orange-200 focus:outline-none mb-6 rounded-lg bg-orange-50" placeholder="ì˜ˆ: ë©ë©ì´">

        <button onclick="startGame()" class="game-btn w-full bg-orange-500 text-white text-2xl py-4 rounded-xl font-bold hover:bg-orange-600">
            ê²Œì„ ì‹œì‘!
        </button>
    </div>
</div>

<div id="main-screen" class="screen bg-sky-100 relative">
    <div class="bg-white p-3 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-2">
            <span class="bg-yellow-400 text-white px-2 py-1 rounded-lg font-bold shadow-sm">Lv.<span id="ui-level">1</span></span>
            <span id="ui-name" class="font-bold text-lg">ì´ë¦„</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center text-yellow-600">
                <i class="fas fa-candy-cane mr-1"></i> <span id="ui-candy">0</span>
            </div>
            <button onclick="openSettings()" class="text-gray-400"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="flex-1 flex flex-col justify-center items-center relative w-full">

        <div class="absolute top-4 w-3/4 max-w-md">
            <div class="flex justify-between text-sm mb-1 font-bold text-blue-600">
                <span>ì„±ì¥ ê²½í—˜ì¹˜</span>
                <span id="ui-exp-text">0/20</span>
            </div>
            <div class="bar-container h-4">
                <div id="ui-exp-bar" class="bg-blue-400 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="absolute top-16 w-full px-8 flex justify-between">
            <div class="flex flex-col items-center">
                <i class="fas fa-drumstick-bite text-orange-500 text-xl mb-1"></i>
                <div class="bar-container w-24 h-3 bg-white">
                    <div id="ui-hunger-bar" class="bg-orange-400 h-full transition-all duration-500" style="width: 100%"></div>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <i class="fas fa-sparkles text-blue-400 text-xl mb-1"></i>
                <div class="bar-container w-24 h-3 bg-white">
                    <div id="ui-clean-bar" class="bg-blue-300 h-full transition-all duration-500" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="relative mt-10">
            <img
                    id="pet-image"
                    src=""
                    onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png'; this.style.width='150px';"
                    class="pet-bounce pixel-art w-48 h-48 object-contain drop-shadow-lg"
                    alt="Pet"
            />
            <div id="poop-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
            <div id="pet-bubble" class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg text-sm font-bold whitespace-nowrap opacity-0 transition-opacity">
                ë°°ê³ íŒŒìš”...
            </div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <button onclick="feedPet()" class="game-btn bg-orange-100 hover:bg-orange-200 py-4 rounded-xl flex flex-col items-center gap-1 border-b-4 border-orange-300">
                <i class="fas fa-utensils text-2xl text-orange-600"></i>
                <span class="font-bold text-orange-800">ë°¥ ì£¼ê¸°</span>
                <span class="text-xs text-orange-600">(ì‚¬íƒ• 3ê°œ)</span>
            </button>
            <button onclick="cleanPoop()" class="game-btn bg-blue-100 hover:bg-blue-200 py-4 rounded-xl flex flex-col items-center gap-1 border-b-4 border-blue-300">
                <i class="fas fa-broom text-2xl text-blue-600"></i>
                <span class="font-bold text-blue-800">ì²­ì†Œí•˜ê¸°</span>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="goToQuizSelect()" class="game-btn bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-xl border-b-4 border-green-700">
                <i class="fas fa-book-open mb-1"></i> ê³µë¶€í•˜ê¸°
            </button>
            <button onclick="goToBattleSetup()" class="game-btn bg-purple-500 hover:bg-purple-600 text-white py-4 rounded-xl font-bold text-xl border-b-4 border-purple-700">
                <i class="fas fa-gamepad mb-1"></i> ë°°í‹€í•˜ê¸°
            </button>
        </div>
        <button onclick="goToCollection()" class="w-full mt-3 py-2 text-gray-500 font-bold bg-gray-100 rounded-lg text-sm">
            <i class="fas fa-book"></i> ì¹œêµ¬ ë„ê° ë³´ê¸°
        </button>
    </div>
</div>

<div id="quiz-select-screen" class="screen bg-green-100 p-6 items-center justify-center">
    <h2 class="text-3xl font-bold text-green-700 mb-8">ë¬´ìŠ¨ ê³µë¶€ë¥¼ í• ê¹Œ?</h2>
    <div class="flex flex-col gap-4 w-full max-w-sm">
        <button onclick="startQuiz('math')" class="game-btn bg-blue-500 text-white text-2xl py-6 rounded-2xl font-bold border-b-4 border-blue-700">
            <i class="fas fa-calculator mr-2"></i> ìˆ˜í•™ í€´ì¦ˆ
        </button>
        <button onclick="startQuiz('korean')" class="game-btn bg-pink-500 text-white text-2xl py-6 rounded-2xl font-bold border-b-4 border-pink-700">
            <i class="fas fa-font mr-2"></i> êµ­ì–´ í€´ì¦ˆ
        </button>
        <button onclick="goHome()" class="mt-4 text-gray-500 underline font-bold">ì§‘ìœ¼ë¡œ ê°€ê¸°</button>
    </div>
</div>

<div id="quiz-play-screen" class="screen bg-white p-6 flex-col items-center">
    <div class="w-full flex justify-between items-center mb-6">
        <div class="text-xl font-bold text-gray-600"><span id="quiz-combo">0</span> ì½¤ë³´! ğŸ”¥</div>
        <div class="w-1/2 bg-gray-200 rounded-full h-4 overflow-hidden border border-gray-400">
            <div id="timer-bar" class="bg-red-500 h-full w-full"></div>
        </div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center w-full">
        <div id="quiz-question" class="text-5xl font-bold mb-12 text-gray-800 text-center break-keep">
            5 + 3 = ?
        </div>

        <div id="quiz-options" class="grid grid-cols-2 gap-4 w-full">
        </div>
    </div>

    <div id="quiz-feedback" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-8xl opacity-0 pointer-events-none" style="text-shadow: 4px 4px 0 #fff;">
        â­•
    </div>

    <button onclick="endQuiz()" class="mt-8 text-gray-400 font-bold border px-4 py-2 rounded-lg">ê·¸ë§Œí•˜ê¸°</button>
</div>

<div id="battle-setup-screen" class="screen bg-purple-900 text-white p-6 items-center justify-center">
    <h2 class="text-3xl font-bold mb-4">ì¹œêµ¬ ì°¾ê¸°</h2>
    <div class="bg-purple-800 p-6 rounded-2xl w-full max-w-sm text-center border-4 border-purple-600 mb-6">
        <i class="fas fa-qrcode text-9xl mb-4 text-white opacity-80"></i>
        <p class="mb-4">ì¹œêµ¬ì˜ QRì½”ë“œë¥¼ ì°ì–´ìš”!<br>(ë˜ëŠ” ì¹œêµ¬ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”)</p>

        <input type="file" id="qr-file-input" accept="image/*" capture="environment" onchange="scanQrImage()">

        <input type="number" id="friend-code-input" class="w-full text-black text-center text-xl p-3 rounded-lg mb-4" placeholder="ì¹œêµ¬ ë²ˆí˜¸">

        <div class="grid grid-cols-2 gap-2">
            <button onclick="document.getElementById('qr-file-input').click()" class="game-btn bg-green-500 py-3 rounded-lg font-bold border-b-4 border-green-700">
                <i class="fas fa-camera"></i> QR ì°ê¸°
            </button>
            <button onclick="searchByNumber()" class="game-btn bg-blue-500 py-3 rounded-lg font-bold border-b-4 border-blue-700">
                ë²ˆí˜¸ ê²€ìƒ‰
            </button>
        </div>
        <button onclick="randomBattle()" class="w-full mt-2 game-btn bg-yellow-500 py-3 rounded-lg font-bold border-b-4 border-yellow-700 text-black">
            ì•„ë¬´ë‚˜ ëŒ€ê²° (ëœë¤)
        </button>
        <!-- âœ… ìƒˆë¡œ ì¶”ê°€: ë‚´ QR ë³´ê¸° ë²„íŠ¼ -->
        <button onclick="openMyQrModal()" class="w-full mt-2 game-btn bg-white text-purple-700 py-3 rounded-lg font-bold border-b-4 border-purple-300">
            <i class="fas fa-id-card"></i> ë‚´ QR ë³´ì—¬ì£¼ê¸°
        </button>
    </div>
    <button onclick="goHome()" class="text-gray-300 underline">ëŒì•„ê°€ê¸°</button>
</div>

<div id="battle-ready-screen" class="screen bg-purple-900 text-white p-6 items-center justify-center">
    <div class="w-full max-w-md bg-purple-800 rounded-2xl border-4 border-purple-600 p-5 shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-yellow-400">ëŒ€ê²° ìƒëŒ€ë¥¼ ì°¾ì•˜ì–´ìš”!</h2>

        <div class="flex justify-around items-center mb-6">
            <div class="flex flex-col items-center">
                <div class="text-sm mb-1 text-purple-200">ë‚˜</div>
                <img id="ready-my-img" src="" class="w-20 h-20 object-contain mb-1 bg-white rounded-full border-2 border-purple-400 p-1">
                <span class="bg-blue-500 px-2 rounded-full text-xs mb-1">Lv.<span id="ready-my-level">1</span></span>
                <div id="ready-my-name" class="font-bold">ë‚´ ì´ë¦„</div>
            </div>

            <div class="text-3xl font-black text-red-400 italic">VS</div>

            <div class="flex flex-col items-center">
                <div class="text-sm mb-1 text-purple-200">ìƒëŒ€</div>
                <img id="ready-enemy-img" src="" class="w-20 h-20 object-contain mb-1 bg-white rounded-full border-2 border-red-400 p-1">
                <span class="bg-red-500 px-2 rounded-full text-xs mb-1">Lv.<span id="ready-enemy-level">?</span></span>
                <div id="ready-enemy-name" class="font-bold">ìƒëŒ€ ì´ë¦„</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="confirmBattle()" class="game-btn bg-yellow-400 text-black py-4 rounded-xl font-bold border-b-4 border-yellow-600 text-lg">
                ì‹¸ìš´ë‹¤!
            </button>
            <button onclick="goToBattleSetup()" class="game-btn bg-gray-500 text-white py-4 rounded-xl font-bold border-b-4 border-gray-700 text-lg">
                ë„ë§ê°€ê¸°
            </button>
        </div>
    </div>
</div>

<div id="battle-screen" class="screen bg-gray-800 relative overflow-hidden">
    <div class="absolute w-full h-full opacity-20 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]"></div>

    <div class="flex flex-col items-center mt-8 z-10">
        <div class="flex items-center gap-2 text-white mb-1">
            <span class="bg-red-500 px-2 rounded font-bold text-sm">Lv.<span id="enemy-level">?</span></span>
            <span id="enemy-name" class="font-bold text-lg">ì¹œêµ¬ í«</span>
        </div>
        <div class="bar-container w-48 h-4 bg-gray-700">
            <div id="enemy-hp-bar" class="bg-red-500 h-full transition-all duration-300" style="width: 100%"></div>
        </div>
        <img id="enemy-pet-img" src="" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png'; this.style.width='100px';" class="w-32 h-32 mt-4 object-contain transition-transform duration-100" alt="Enemy">
    </div>

    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
        <span class="text-6xl font-black text-yellow-500 italic drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)]">VS</span>
    </div>

    <div class="flex flex-col items-center mb-8 mt-auto z-10">
        <img id="my-battle-img" src="" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png'; this.style.width='100px';" class="w-32 h-32 mb-4 object-contain transition-transform duration-100" alt="Me">
        <div class="bar-container w-48 h-4 bg-gray-700">
            <div id="my-hp-bar" class="bg-green-500 h-full transition-all duration-300" style="width: 100%"></div>
        </div>
        <div class="flex items-center gap-2 text-white mt-1">
            <span class="bg-blue-500 px-2 rounded font-bold text-sm">Lv.<span id="my-battle-level">?</span></span>
            <span id="my-battle-name" class="font-bold text-lg">ë‚´ í«</span>
        </div>
    </div>

    <div id="battle-message" class="absolute bottom-1/2 transform translate-y-16 w-full text-center text-white text-xl font-bold drop-shadow-md z-30 opacity-0 transition-opacity">
        ì „íˆ¬ ì‹œì‘!
    </div>

    <button onclick="skipBattle()" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded text-sm z-50">ê²°ê³¼ ë³´ê¸° >></button>
</div>

<div id="battle-result-screen" class="screen bg-black bg-opacity-90 absolute top-0 left-0 w-full h-full z-50 justify-center items-center text-white text-center">
    <h2 id="result-title" class="text-5xl font-bold mb-4 text-yellow-400">ìŠ¹ë¦¬!</h2>
    <div id="result-reward" class="mb-8 text-xl">
        <p>ì‚¬íƒ• +3ê°œ</p>
        <p>ê²½í—˜ì¹˜ +10</p>
    </div>
    <button onclick="finishBattle()" class="game-btn bg-white text-black px-8 py-3 rounded-xl font-bold text-xl">
        ì§‘ìœ¼ë¡œ
    </button>
</div>

<div id="collection-screen" class="screen bg-indigo-50 p-6 flex-col">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-indigo-800">ì¹œêµ¬ ë„ê°</h2>
        <button onclick="goHome()" class="bg-gray-300 px-3 py-1 rounded font-bold text-gray-700">ë‹«ê¸°</button>
    </div>
    <div id="collection-list" class="grid grid-cols-2 gap-4 overflow-y-auto pb-4">
    </div>
</div>

<script>
    /* --- 1. ê²Œì„ ë°ì´í„° ë° ìƒíƒœ ê´€ë¦¬ --- */
    let gameState = {
        player: {
            number: 0,
            name: "",
            level: 1,
            exp: 0,
            maxHp: 30,
            attack: 5,
            hunger: 100,
            cleanliness: 100,
            poops: 0,
            candies: 5,
            characterId: '00'
        },
        collection: [],
        lastTickTime: Date.now()
    };

    const LEVEL_EXP_BASE = 20;
    const LEVEL_EXP_INC = 5;

    window.onload = function() {
        loadGame();
    };

    function saveGame() {
        gameState.lastTickTime = Date.now();
        localStorage.setItem('myPetSchoolDataV3', JSON.stringify(gameState));
    }

    function loadGame() {
        const data = localStorage.getItem('myPetSchoolDataV3');
        if (data) {
            const parsed = JSON.parse(data);
            gameState = { ...gameState, ...parsed, player: { ...gameState.player, ...parsed.player } };
            calculateOfflineProgress();

            if (gameState.player.name) {
                showScreen('main-screen');
                startGameLoop();
            } else {
                showScreen('start-screen');
            }
        } else {
            showScreen('start-screen');
        }
        updateUI();
    }

    function calculateOfflineProgress() {
        const now = Date.now();
        const diffMs = now - gameState.lastTickTime;
        const diffMinutes = Math.floor(diffMs / 60000);

        if (diffMinutes > 0) {
            const hungerDrop = Math.floor(diffMinutes / 30) * 10;
            gameState.player.hunger = Math.max(0, gameState.player.hunger - hungerDrop);

            const hours = Math.floor(diffMinutes / 60);
            if (hours > 0) {
                gameState.player.cleanliness = Math.max(0, gameState.player.cleanliness - (hours * 10));
                for(let i=0; i<hours; i++) {
                    if(Math.random() > 0.5 && gameState.player.poops < 3) {
                        gameState.player.poops++;
                    }
                }
            }
        }
        gameState.lastTickTime = now;
    }

    function startGame() {
        const num = document.getElementById('student-number').value;
        const name = document.getElementById('pet-name').value;

        if (!num || !name) {
            alert('ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì ì–´ì£¼ì„¸ìš”!');
            return;
        }

        const n = Math.max(0, Math.min(99, parseInt(num, 10) || 0)); // 0~99 ì œí•œ

        gameState.player.number = n;
        gameState.player.name = name;
        gameState.player.characterId = n.toString().padStart(2, "0");

        saveGame();
        showScreen('main-screen');
        startGameLoop();
        updateUI();
    }


    /* --- 2. ë©”ì¸ ê²Œì„ ë£¨í”„ & UI --- */
    let gameInterval;

    function startGameLoop() {
        if(gameInterval) clearInterval(gameInterval);
        gameInterval = setInterval(() => {
            const now = Date.now();
            if (now - gameState.lastTickTime > 60000) {
                calculateOfflineProgress();
                saveGame();
                updateUI();
            }
        }, 10000);
        renderPoops();
    }

    function updateUI() {
        const p = gameState.player;
        document.getElementById('ui-level').innerText = p.level;
        document.getElementById('ui-name').innerText = p.name;
        document.getElementById('ui-candy').innerText = p.candies;

        const reqExp = LEVEL_EXP_BASE + (p.level - 1) * LEVEL_EXP_INC;
        const expPct = (p.exp / reqExp) * 100;
        document.getElementById('ui-exp-bar').style.width = `${expPct}%`;
        document.getElementById('ui-exp-text').innerText = `${p.exp}/${reqExp}`;

        document.getElementById('ui-hunger-bar').style.width = `${p.hunger}%`;
        document.getElementById('ui-clean-bar').style.width = `${p.cleanliness}%`;

        // ë©”ì¸ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        const imgEl = document.getElementById('pet-image');
        imgEl.src = `./png/${p.characterId}.png`;

        const bubble = document.getElementById('pet-bubble');
        if (p.hunger < 30) {
            bubble.innerText = "ë°°ê³ íŒŒìš”...";
            bubble.style.opacity = 1;
        } else if (p.cleanliness < 30 || p.poops > 0) {
            bubble.innerText = "ëƒ„ìƒˆë‚˜ìš”...";
            bubble.style.opacity = 1;
        } else {
            bubble.style.opacity = 0;
        }
    }

    function renderPoops() {
        const container = document.getElementById('poop-container');
        container.innerHTML = '';
        for(let i=0; i<gameState.player.poops; i++) {
            const poop = document.createElement('div');
            poop.className = 'poop';
            poop.innerText = 'ğŸ’©';
            poop.style.left = `${20 + (i*25)}%`;
            poop.style.bottom = '10%';
            poop.onclick = (e) => {
                e.stopPropagation();
                cleanPoop();
            };
            container.appendChild(poop);
        }
    }

    /* --- 3. í« ê´€ë¦¬ ì•¡ì…˜ --- */
    function feedPet() {
        if (gameState.player.candies < 3) {
            alert('ì‚¬íƒ•ì´ ë¶€ì¡±í•´ìš”! ê³µë¶€ë‚˜ ë°°í‹€ì„ í•´ì„œ ì‚¬íƒ•ì„ ëª¨ì•„ìš”.');
            return;
        }
        if (gameState.player.hunger >= 100) {
            alert('ë°°ê°€ ë¶ˆëŸ¬ìš”!');
            return;
        }
        gameState.player.candies -= 3;
        gameState.player.hunger = Math.min(100, gameState.player.hunger + 40);
        if(Math.random() < 0.1) {
            addExp(5);
            alert('ë§›ìˆê²Œ ë¨¹ê³  ì‘¥ì‘¥ ì»¸ì–´ìš”! (+5 EXP)');
        }
        saveGame();
        updateUI();

        const img = document.getElementById('pet-image');
        img.style.transform = "scale(1.2)";
        setTimeout(() => img.style.transform = "scale(1)", 200);
    }

    function cleanPoop() {
        if (gameState.player.poops === 0 && gameState.player.cleanliness >= 90) {
            alert('ì´ë¯¸ ê¹¨ë—í•´ìš”!');
            return;
        }
        if (gameState.player.poops > 0) {
            gameState.player.poops = 0;
            addExp(2);
        }
        gameState.player.cleanliness = 100;
        saveGame();
        updateUI();
        renderPoops();
    }

    function addExp(amount) {
        gameState.player.exp += amount;
        const reqExp = LEVEL_EXP_BASE + (gameState.player.level - 1) * LEVEL_EXP_INC;
        if (gameState.player.exp >= reqExp) {
            gameState.player.level++;
            gameState.player.exp -= reqExp;
            gameState.player.maxHp += 2;
            gameState.player.attack += 1;
            alert(`ë ˆë²¨ ì—…! Lv.${gameState.player.level} ì´ ë˜ì—ˆì–´ìš”!`);
        }
    }

    /* --- 4. í€´ì¦ˆ ì‹œìŠ¤í…œ (ìˆ˜ì •ë¨) --- */
    let quizTimer, currentSubject = '', combo = 0, timeLeft = 10;
    let koreanProblemSet = []; // êµ­ì–´ ë¬¸ì œ ì €ì¥ìš©

    function goToQuizSelect() { showScreen('quiz-select-screen'); }

    async function startQuiz(subject) {
        currentSubject = subject;
        combo = 0;
        document.getElementById('quiz-combo').innerText = 0;

        // êµ­ì–´ í€´ì¦ˆì¼ ê²½ìš° ë¡œì»¬ JSON íŒŒì¼ ë¡œë“œ
        if (subject === 'korean') {
            try {
                // ì£¼ì˜: ë¡œì»¬ íŒŒì¼(index.html)ì„ ê·¸ëƒ¥ ì—´ë©´ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ fetchê°€ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì›¹ ì„œë²„(Live Server ë“±)ë¥¼ í†µí•´ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
                const response = await fetch('./quiz/Koquiz.json');
                if (!response.ok) throw new Error("JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const data = await response.json();
                koreanProblemSet = data.questions;
            } catch (error) {
                console.error(error);
                alert("í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n(ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆìƒ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)");
                return;
            }
        }

        showScreen('quiz-play-screen');
        nextQuestion();
    }

    function nextQuestion() {
        timeLeft = 10;
        updateTimerBar();
        if(quizTimer) clearInterval(quizTimer);
        quizTimer = setInterval(() => {
            timeLeft -= 0.1;
            updateTimerBar();
            if (timeLeft <= 0) handleWrong();
        }, 100);
        generateQuestion();
    }

    function updateTimerBar() {
        const pct = (timeLeft / 10) * 100;
        document.getElementById('timer-bar').style.width = `${pct}%`;
    }

    function generateQuestion() {
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        const qDiv = document.getElementById('quiz-question');
        let questionText = "", answer = 0, options = [];

        if (currentSubject === 'math') {
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            if (Math.random() > 0.5) {
                questionText = `${a} + ${b} = ?`;
                answer = a + b;
            } else {
                const max = Math.max(a, b), min = Math.min(a, b);
                questionText = `${max} - ${min} = ?`;
                answer = max - min;
            }
            options = [answer, answer + 1, answer - 1, answer + 2];
            options.sort(() => Math.random() - 0.5);
            options = [...new Set(options)];
            while(options.length < 4) options.push(options[0]+1);
        }
        else if (currentSubject === 'korean') {
            // JSONì—ì„œ ë¡œë“œëœ ë¬¸ì œ ì¤‘ ëœë¤ ì„ íƒ
            if (!koreanProblemSet || koreanProblemSet.length === 0) {
                alert("ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                endQuiz();
                return;
            }
            const randIdx = Math.floor(Math.random() * koreanProblemSet.length);
            const q = koreanProblemSet[randIdx];

            questionText = q.prompt; // ë¬¸ì œ (ì˜ˆ: "_êµ")
            options = q.choices; // ë³´ê¸° ë°°ì—´
            answer = q.choices[q.answerIndex]; // ì •ë‹µ í…ìŠ¤íŠ¸
        }

        qDiv.innerText = questionText;
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "bg-blue-100 hover:bg-blue-200 text-2xl font-bold py-8 rounded-xl border-b-4 border-blue-300 w-full h-full";
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt, answer);
            container.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct) {
        clearInterval(quizTimer);

        // --- ìŠ¤íƒ¯ ë³€ë™ ë¡œì§ ì¶”ê°€ ---
        // ê³µë¶€í•˜ê¸°ë¥¼ ì‹œë„í•˜ë©´ ë°°ê³ í”” ê°ì†Œ
        gameState.player.hunger = Math.max(0, gameState.player.hunger - 3);
        // ì¼ì • í™•ë¥ (30%)ë¡œ ì²­ê²°ë„ ê°ì†Œ
        if (Math.random() < 0.3) {
            gameState.player.cleanliness = Math.max(0, gameState.player.cleanliness - 5);
        }
        updateUI(); // UIì— ì¦‰ì‹œ ë°˜ì˜
        saveGame();

        if (String(selected) === String(correct)) {
            combo++;
            showFeedback("â­•");
            let expGain = 5 + (combo > 1 ? combo : 0);
            addExp(expGain);
            if (combo % 3 === 0) gameState.player.candies++;
            document.getElementById('quiz-combo').innerText = combo;
            setTimeout(nextQuestion, 800);
        } else {
            // í‹€ë¦¬ë©´ ë°”ë¡œ ì¢…ë£Œ
            handleWrong();
        }
    }

    function handleWrong() {
        showFeedback("âŒ");
        combo = 0;
        document.getElementById('quiz-combo').innerText = 0;

        // ì˜¤ë‹µ ì‹œ ì ì‹œ í›„ í€´ì¦ˆ ì¢…ë£Œ (ì¦‰ì‚¬)
        setTimeout(() => {
            alert("í‹€ë ¸ì–´ìš”! ê³µë¶€ê°€ ëë‚¬ìŠµë‹ˆë‹¤.");
            endQuiz();
        }, 1000);
    }

    function showFeedback(emoji) {
        const el = document.getElementById('quiz-feedback');
        el.innerText = emoji;
        el.style.opacity = 1;
        setTimeout(() => { el.style.opacity = 0; }, 500);
    }

    function endQuiz() {
        clearInterval(quizTimer);
        showScreen('main-screen');
        updateUI();
    }

    /* --- 5. ë°°í‹€ ì‹œìŠ¤í…œ --- */
    let battleState = { me: {}, enemy: {}, plan: [], turn: 0, isWin: false, pendingEnemy: null };

    function goToBattleSetup() {
        showScreen('battle-setup-screen');
    }

    function scanQrImage() {
        const fileInput = document.getElementById('qr-file-input');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);

                if (code) {
                    handleQrPayload(code.data);
                } else {
                    alert('QR ì½”ë“œë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì°ì–´ì£¼ì„¸ìš”.');
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // âœ… QR ë‚´ìš© í•´ì„: JSON / URL / ì½œë¡  ë¶„ë¦¬ ì „ë¶€ ì§€ì›
    function handleQrPayload(data) {
        const raw = String(data || "").trim();
        console.log("[QR RAW]", raw);

        // 1) JSON í˜•ì‹ ë¨¼ì € ì²˜ë¦¬ (kind ì—†ì–´ë„ number/num ìˆìœ¼ë©´ ì¸ì •)
        try {
            if (raw.startsWith("{") && raw.endsWith("}")) {
                const obj = JSON.parse(raw);
                if (obj && (obj.number != null || obj.num != null)) {
                    const num = Number(obj.number ?? obj.num);
                    if (!Number.isNaN(num) && num > 0) {
                        const name = obj.name || `ì¹œêµ¬ ${num}`;
                        const level =
                            Number(obj.level) || gameState.player.level || 1;
                        enterBattleReady({ number: num, name, level });
                        return;
                    }
                }
            }
        } catch (e) {
            console.warn("QR JSON parse error", e);
        }

        // 2) URL í˜•ì‹ ì²˜ë¦¬: ?number=15 ë˜ëŠ” ?n=15 ê°™ì´ ì˜¤ëŠ” ê²½ìš°
        try {
            if (/^https?:\/\//i.test(raw)) {
                const url = new URL(raw);
                const numStr =
                    url.searchParams.get("number") ??
                    url.searchParams.get("n");
                if (numStr) {
                    const num = Number(numStr);
                    if (!Number.isNaN(num) && num > 0) {
                        const name =
                            url.searchParams.get("name") || `ì¹œêµ¬ ${num}`;
                        const level =
                            Number(url.searchParams.get("level")) ||
                            gameState.player.level ||
                            1;
                        enterBattleReady({ number: num, name, level });
                        return;
                    }
                }
            }
        } catch (e) {
            console.warn("QR URL parse error", e);
        }

        // 3) "pet-qr:..." ê°™ì€ prefixê°€ ë¶™ì€ ê²½ìš° ì˜ë¼ë‚´ê¸°
        let text = raw;
        if (text.startsWith("pet-qr:")) {
            text = text.slice("pet-qr:".length);
        }

        // 4) ì½œë¡ (:)ìœ¼ë¡œ êµ¬ë¶„ëœ ê°„ë‹¨í•œ í¬ë§·: num[:name[:level]]
        const parts = text.split(":");
        const num = Number(parts[0]);
        if (!Number.isNaN(num) && num > 0) {
            const name = parts[1] || `ì¹œêµ¬ ${num}`;
            const level =
                Number(parts[2]) || gameState.player.level || 1;
            enterBattleReady({ number: num, name, level });
            return;
        }

        alert("ì•Œ ìˆ˜ ì—†ëŠ” QR ì½”ë“œì…ë‹ˆë‹¤.\n\nQR ë‚´ìš©: " + raw);
    }


    // âœ… ë‚´ í« ì •ë³´ë¥¼ QRë¡œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥
    // âœ… ë‚´ í« ì •ë³´ë¥¼ QRë¡œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ (ì•ˆì „í•˜ê²Œ ìˆ˜ì • ë²„ì „)
    function openMyQrModal() {
        // 1) ê²Œì„ ì‹œì‘ ì•ˆ í–ˆìœ¼ë©´ ë¨¼ì € ì‹œì‘ ìœ ë„
        if (!gameState.player.number || !gameState.player.name) {
            alert('ë¨¼ì € "ê²Œì„ ì‹œì‘"ì—ì„œ ë‚´ ë²ˆí˜¸ì™€ í« ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        const payloadObj = {
            kind: "pet-qr",
            number: gameState.player.number,
            name: gameState.player.name,
            level: gameState.player.level || 1,
        };
        const payload = JSON.stringify(payloadObj);

        const box = document.getElementById("my-qr-box");
        const textEl = document.getElementById("my-qr-text");
        const modal = document.getElementById("my-qr-modal");

        if (!box || !textEl || !modal) {
            alert("QR ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. (my-qr-box / my-qr-text / my-qr-modal)");
            return;
        }

        // 2) ì´ì „ QR ì§€ìš°ê¸°
        box.innerHTML = "";

        // 3) QR ìƒì„±ì€ try/catchë¡œ ê°ì‹¸ì„œ ì—ëŸ¬ ë‚˜ë„ ëª¨ë‹¬ì€ ëœ¨ê²Œ ì²˜ë¦¬
        try {
            if (window.QRCode) {
                new QRCode(box, {
                    text: payload,
                    width: 200,
                    height: 200,
                });
            } else {
                box.textContent = "QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.";
            }
        } catch (e) {
            console.error("QR ìƒì„± ì¤‘ ì˜¤ë¥˜", e);
            box.textContent = "QR ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }

        // 4) QR ë‚´ìš© í…ìŠ¤íŠ¸ë„ í‘œì‹œ (ë””ë²„ê·¸ / ì„¤ëª…ìš©)
        textEl.textContent = payload;

        // 5) ëª¨ë‹¬ ë³´ì´ê¸°
        modal.classList.remove("hidden");
    }

    function closeMyQrModal() {
        const modal = document.getElementById("my-qr-modal");
        if (modal) {
            modal.classList.add("hidden");
        }
    }

    // âœ… í˜¹ì‹œ ëª¨ë¥¼ ì „ì—­ ë²”ìœ„ ë¬¸ì œ ì˜ˆë°©: ë²„íŠ¼ onclickì—ì„œ í™•ì‹¤íˆ ì°¾ì„ ìˆ˜ ìˆë„ë¡ export
    window.openMyQrModal = openMyQrModal;
    window.closeMyQrModal = closeMyQrModal;


    function closeMyQrModal() {
        const modal = document.getElementById('my-qr-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }



    function searchByNumber() {
        const input = document.getElementById('friend-code-input').value;
        if(!input) { alert('ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        const lvl = Math.max(1, gameState.player.level + (Math.floor(Math.random()*5)-2));
        enterBattleReady({
            number: Number(input),
            name: `ì¹œêµ¬ ${input}`,
            level: lvl
        });
    }

    function randomBattle() {
        const lvl = Math.max(1, gameState.player.level + (Math.floor(Math.random()*5)-2));
        enterBattleReady({
            number: 999,
            name: "ì•¼ìƒì˜ í«",
            level: lvl
        });
    }

    function enterBattleReady(enemyData) {
        battleState.pendingEnemy = enemyData;

        document.getElementById('ready-my-name').innerText = gameState.player.name;
        document.getElementById('ready-my-level').innerText = gameState.player.level;
        document.getElementById('ready-my-img').src = `./png/${gameState.player.characterId}.png`;
        document.getElementById('ready-my-img').onerror = function() { this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png'; };

        document.getElementById('ready-enemy-name').innerText = enemyData.name;
        document.getElementById('ready-enemy-level').innerText = enemyData.level;

        let enemyImgId = (enemyData.number || 0).toString().padStart(2, "0");
        document.getElementById('ready-enemy-img').src = `./png/${enemyImgId}.png`;
        document.getElementById('ready-enemy-img').onerror = function() { this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png'; };

        showScreen('battle-ready-screen');
    }

    function confirmBattle() {
        if(!battleState.pendingEnemy) return;
        startBattle(battleState.pendingEnemy);
    }

    function startBattle(enemyData) {
        const myStats = {
            name: gameState.player.name,
            hp: gameState.player.maxHp,
            maxHp: gameState.player.maxHp,
            level: gameState.player.level
        };

        const enemyMaxHp = 30 + (enemyData.level - 1) * 2;
        const enemyStats = {
            name: enemyData.name,
            hp: enemyMaxHp,
            maxHp: enemyMaxHp,
            level: enemyData.level,
            number: enemyData.number
        };

        battleState = {
            me: myStats,
            enemy: enemyStats,
            turn: 0,
            isWin: false,
            pendingEnemy: null
        };

        const levelDiff = myStats.level - enemyStats.level;
        let winChance = 0.5 + (levelDiff * 0.1);
        winChance = Math.max(0.1, Math.min(0.9, winChance));
        battleState.isWin = Math.random() < winChance;

        let turns = 5;
        if (Math.abs(levelDiff) >= 3) turns = 3;

        battleState.plan = generateBattlePlan(myStats, enemyStats, battleState.isWin, turns);

        document.getElementById('my-battle-level').innerText = myStats.level;
        document.getElementById('my-battle-name').innerText = myStats.name;
        document.getElementById('enemy-level').innerText = enemyStats.level;
        document.getElementById('enemy-name').innerText = enemyStats.name;

        document.getElementById('my-battle-img').src = document.getElementById('ready-my-img').src;
        document.getElementById('enemy-pet-img').src = document.getElementById('ready-enemy-img').src;

        document.getElementById('my-hp-bar').style.width = '100%';
        document.getElementById('enemy-hp-bar').style.width = '100%';
        document.getElementById('battle-result-screen').style.display = 'none';

        showScreen('battle-screen');
        setTimeout(playNextTurn, 1000);
    }

    function generateBattlePlan(me, enemy, iWin, turns) {
        let plan = [];
        let currentMyHp = me.maxHp;
        let currentEnemyHp = enemy.maxHp;
        let targetMyHp, targetEnemyHp;

        if (iWin) {
            targetEnemyHp = 0;
            targetMyHp = Math.floor(me.maxHp * (0.2 + Math.random() * 0.6));
        } else {
            targetMyHp = 0;
            targetEnemyHp = Math.floor(enemy.maxHp * (0.2 + Math.random() * 0.6));
        }

        const totalDmgToEnemy = enemy.maxHp - targetEnemyHp;
        const totalDmgToMe = me.maxHp - targetMyHp;
        let dmgToEnemyPerTurn = Math.floor(totalDmgToEnemy / Math.ceil(turns/2));
        let dmgToMePerTurn = Math.floor(totalDmgToMe / Math.floor(turns/2));

        let isMyTurn = true;
        for(let i=0; i<turns; i++) {
            if (isMyTurn) {
                let dmg = dmgToEnemyPerTurn + Math.floor(Math.random()*2);
                if (currentEnemyHp - dmg < 0) dmg = currentEnemyHp;
                if (i === turns-1 && iWin) dmg = currentEnemyHp;
                currentEnemyHp -= dmg;
                plan.push({ attacker: 'me', damage: dmg, remainingEnemyHp: currentEnemyHp, remainingMyHp: currentMyHp });
            } else {
                let dmg = dmgToMePerTurn + Math.floor(Math.random()*2);
                if (currentMyHp - dmg < 0) dmg = currentMyHp;
                if (i === turns-1 && !iWin) dmg = currentMyHp;
                currentMyHp -= dmg;
                plan.push({ attacker: 'enemy', damage: dmg, remainingEnemyHp: currentEnemyHp, remainingMyHp: currentMyHp });
            }
            isMyTurn = !isMyTurn;
            if (currentEnemyHp <= 0 || currentMyHp <= 0) break;
        }
        return plan;
    }

    function playNextTurn() {
        if (battleState.turn >= battleState.plan.length) {
            showBattleResult();
            return;
        }

        const action = battleState.plan[battleState.turn];
        const msgEl = document.getElementById('battle-message');
        const myImg = document.getElementById('my-battle-img');
        const enemyImg = document.getElementById('enemy-pet-img');

        if (action.attacker === 'me') {
            msgEl.innerText = "ë‚˜ì˜ ê³µê²©!";
            myImg.style.transform = "translateX(50px) rotate(10deg)";
            setTimeout(() => myImg.style.transform = "translateX(0)", 200);
            setTimeout(() => {
                enemyImg.style.opacity = 0.5;
                setTimeout(() => enemyImg.style.opacity = 1, 100);
                updateHpBars(action.remainingMyHp, battleState.me.maxHp, action.remainingEnemyHp, battleState.enemy.maxHp);
                showDamage(action.damage, 'enemy');
            }, 200);
        } else {
            msgEl.innerText = `${battleState.enemy.name}ì˜ ê³µê²©!`;
            enemyImg.style.transform = "translateX(-50px) rotate(-10deg)";
            setTimeout(() => enemyImg.style.transform = "translateX(0)", 200);
            setTimeout(() => {
                myImg.style.opacity = 0.5;
                setTimeout(() => myImg.style.opacity = 1, 100);
                updateHpBars(action.remainingMyHp, battleState.me.maxHp, action.remainingEnemyHp, battleState.enemy.maxHp);
                showDamage(action.damage, 'me');
            }, 200);
        }

        msgEl.style.opacity = 1;
        setTimeout(() => msgEl.style.opacity = 0, 800);
        battleState.turn++;
        setTimeout(playNextTurn, 1500);
    }

    function showDamage(amount, target) {
        const el = document.createElement('div');
        el.className = 'damage-text';
        el.innerText = `-${amount}`;
        if (target === 'enemy') {
            el.style.top = '20%';
            el.style.left = '50%';
        } else {
            el.style.bottom = '20%';
            el.style.left = '50%';
        }
        document.getElementById('battle-screen').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function updateHpBars(myCur, myMax, enCur, enMax) {
        document.getElementById('my-hp-bar').style.width = `${(myCur/myMax)*100}%`;
        document.getElementById('enemy-hp-bar').style.width = `${(enCur/enMax)*100}%`;
    }

    function skipBattle() {
        const last = battleState.plan[battleState.plan.length - 1];
        updateHpBars(last.remainingMyHp, battleState.me.maxHp, last.remainingEnemyHp, battleState.enemy.maxHp);
        battleState.turn = battleState.plan.length;
        setTimeout(showBattleResult, 500);
    }

    function showBattleResult() {
        const screen = document.getElementById('battle-result-screen');
        screen.style.display = 'flex';
        const title = document.getElementById('result-title');
        const reward = document.getElementById('result-reward');

        if (battleState.isWin) {
            title.innerText = "ìŠ¹ë¦¬!";
            title.style.color = "#FBBF24";
            reward.innerHTML = "<p>ì‚¬íƒ• +3ê°œ</p><p>ê²½í—˜ì¹˜ +10</p>";
            gameState.player.candies += 3;
            addExp(10);
            addToCollection(battleState.enemy);
        } else {
            title.innerText = "ì•„ì‰¬ì›Œìš”...";
            title.style.color = "#9CA3AF";
            reward.innerHTML = "<p>ìœ„ë¡œê¸ˆ: ì‚¬íƒ• +1ê°œ</p>";
            gameState.player.candies += 1;
        }
        saveGame();
    }

    function finishBattle() {
        document.getElementById('battle-result-screen').style.display = 'none';
        showScreen('main-screen');
        updateUI();
    }

    /* --- 6. ë„ê° ì‹œìŠ¤í…œ --- */
    function addToCollection(enemy) {
        const exists = gameState.collection.find(c => c.name === enemy.name);
        if (!exists) {
            gameState.collection.push({
                name: enemy.name,
                level: enemy.level,
                number: enemy.number,
                date: new Date().toLocaleDateString()
            });
        }
    }

    function goToCollection() {
        showScreen('collection-screen');
        const list = document.getElementById('collection-list');
        list.innerHTML = '';

        if (gameState.collection.length === 0) {
            list.innerHTML = '<div class="col-span-2 text-center text-gray-400 mt-10">ì•„ì§ ë§Œë‚œ ì¹œêµ¬ê°€ ì—†ì–´ìš”.<br>ë°°í‹€ì„ í•´ì„œ ì¹œêµ¬ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!</div>';
            return;
        }

        gameState.collection.forEach(friend => {
            const el = document.createElement('div');
            el.className = "bg-white p-3 rounded-xl shadow border border-indigo-100 flex flex-col items-center";
            const imgId = (friend.number || 0).toString().padStart(2, "0");

            el.innerHTML = `
                    <img src="./png/${imgId}.png" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png'; this.style.width='60px';" class="w-16 h-16 object-contain mb-2">
                    <div class="font-bold text-indigo-900">${friend.name}</div>
                    <div class="text-sm text-gray-500">Lv.${friend.level}</div>
                `;
            list.appendChild(el);
        });
    }

    /* --- ìœ í‹¸ë¦¬í‹° --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
        });
        const target = document.getElementById(id);
        target.classList.add('active');
        target.style.display = 'flex';
    }

    function goHome() {
        showScreen('main-screen');
        updateUI();
    }

    function openSettings() {
        if(confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ í• ê¹Œìš”? (ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì ¸ìš”)')) {
            localStorage.removeItem('myPetSchoolDataV3');
            location.reload();
        }
    }

</script>

<!-- âœ… ë‚´ í« QR ëª¨ë‹¬ -->
<div id="my-qr-modal"
     class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 w-72 text-center relative shadow-2xl border-4 border-purple-400">
        <button
                onclick="closeMyQrModal()"
                class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl leading-none">
            âœ•
        </button>
        <h3 class="text-xl font-bold mb-2 text-purple-700">ë‚´ í« QR</h3>
        <p class="text-xs text-gray-600 mb-2">
            ì¹œêµ¬ëŠ” ì´ QRì„ ì°ì–´ì„œ<br />ë‚˜ì™€ ë°°í‹€í•  ìˆ˜ ìˆì–´ìš”!
        </p>

        <div
                id="my-qr-box"
                class="bg-white p-2 rounded-xl flex items-center justify-center mb-2"
        ></div>

        <div
                id="my-qr-text"
                class="text-[10px] text-gray-500 break-words bg-gray-100 rounded-lg p-1"
        ></div>
    </div>
</div>


</body>
</html>