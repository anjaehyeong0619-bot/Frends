<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ í•™êµ í« í‚¤ìš°ê¸° V3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        body {
            font-family: 'Jua', sans-serif;
            background-color: #FFFBEB;
            touch-action: manipulation;
            user-select: none;
        }

        .screen {
            display: none;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }

        .active {
            display: flex;
        }

        /* í« ì´ë¯¸ì§€ ì• ë‹ˆë©”ì´ì…˜ */
        .pet-bounce {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* ì½¤ë³´ ì´í™íŠ¸ */
        .combo-text {
            position: absolute;
            font-size: 2rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
            animation: popUp 0.5s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes popUp {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.5);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* ë°°í‹€ ë°ë¯¸ì§€ */
        .damage-text {
            position: absolute;
            font-size: 1.5rem;
            color: #EF4444;
            font-weight: bold;
            animation: floatUp 1s forwards;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        /* í”½ì…€ ì•„íŠ¸ ì´ë¯¸ì§€ ì„ ëª…í•˜ê²Œ í‘œì‹œ */
        .pixel-art {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
        }

        /* ê²Œì´ì§€ ë°” ìŠ¤íƒ€ì¼ */
        .bar-container {
            background: #E5E7EB;
            border-radius: 999px;
            overflow: hidden;
            border: 2px solid #374151;
        }

        /* ë˜¥ ì´ë¯¸ì§€ */
        .poop {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .poop:active {
            transform: scale(0.8);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .game-btn {
            transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
        }

        .game-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
        }

        /* íŒŒì¼ ì¸í’‹ ìˆ¨ê¸°ê¸° (ì»¤ìŠ¤í…€ ë²„íŠ¼ ì—°ê²°ìš©) */
        #qr-file-input {
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">

<div id="start-screen" class="screen active justify-center items-center bg-yellow-100 p-6">
    <h1 class="text-4xl text-orange-500 mb-8 text-center drop-shadow-md">
        <i class="fas fa-paw"></i> ìš°ë¦¬ í•™êµ<br>í« í‚¤ìš°ê¸° V3.1
    </h1>
    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center border-4 border-orange-300">
        <p class="mb-4 text-xl">ìê¸° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ìš”!</p>
        <input type="number" id="student-number"
               class="w-full text-center text-3xl p-3 border-b-4 border-orange-200 focus:outline-none mb-4 rounded-lg bg-orange-50"
               placeholder="ë²ˆí˜¸ (ì˜ˆ: 15)">
        <p class="mb-2 text-lg">í«ì˜ ì´ë¦„ì€?</p>
        <input type="text" id="pet-name"
               class="w-full text-center text-2xl p-3 border-b-4 border-orange-200 focus:outline-none mb-6 rounded-lg bg-orange-50"
               placeholder="ì˜ˆ: ë©ë©ì´">

        <button onclick="startGame()"
                class="game-btn w-full bg-orange-500 text-white text-2xl py-4 rounded-xl font-bold hover:bg-orange-600">
            ê²Œì„ ì‹œì‘!
        </button>
    </div>
</div>

<div id="main-screen" class="screen bg-sky-100 relative">
    <div class="bg-white p-3 flex justify-between items-center shadow-md z-10">
        <div class="flex items-center gap-2">
            <span class="bg-yellow-400 text-white px-2 py-1 rounded-lg font-bold shadow-sm">
                Lv.<span id="ui-level">1</span>
            </span>
            <span id="ui-name" class="font-bold text-lg">ì´ë¦„</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center text-yellow-600">
                <i class="fas fa-candy-cane mr-1"></i> <span id="ui-candy">0</span>
            </div>
            <button onclick="openSettings()" class="text-gray-400"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="flex-1 flex flex-col justify-center items-center relative w-full">

        <div class="absolute top-4 w-3/4 max-w-md">
            <div class="flex justify-between text-sm mb-1 font-bold text-blue-600">
                <span>ì„±ì¥ ê²½í—˜ì¹˜</span>
                <span id="ui-exp-text">0/20</span>
            </div>
            <div class="bar-container h-4">
                <div id="ui-exp-bar" class="bg-blue-400 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div class="absolute top-16 w-full px-8 flex justify-between">
            <div class="flex flex-col items-center">
                <i class="fas fa-drumstick-bite text-orange-500 text-xl mb-1"></i>
                <div class="bar-container w-24 h-3 bg-white">
                    <div id="ui-hunger-bar" class="bg-orange-400 h-full transition-all duration-500"
                         style="width: 100%"></div>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <i class="fas fa-sparkles text-blue-400 text-xl mb-1"></i>
                <div class="bar-container w-24 h-3 bg-white">
                    <div id="ui-clean-bar" class="bg-blue-300 h-full transition-all duration-500"
                         style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="relative mt-10">
            <img
                    id="pet-image"
                    src=""
                    onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png'; this.style.width='150px';"
                    class="pet-bounce pixel-art w-48 h-48 object-contain drop-shadow-lg"
                    alt="Pet"
            />
            <div id="poop-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
            <div id="pet-bubble"
                 class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg text-sm font-bold whitespace-nowrap opacity-0 transition-opacity">
                ë°°ê³ íŒŒìš”...
            </div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <button onclick="feedPet()"
                    class="game-btn bg-orange-100 hover:bg-orange-200 py-4 rounded-xl flex flex-col items-center gap-1 border-b-4 border-orange-300">
                <i class="fas fa-utensils text-2xl text-orange-600"></i>
                <span class="font-bold text-orange-800">ë°¥ ì£¼ê¸°</span>
                <span class="text-xs text-orange-600">(ì‚¬íƒ• 3ê°œ)</span>
            </button>
            <button onclick="cleanPoop()"
                    class="game-btn bg-blue-100 hover:bg-blue-200 py-4 rounded-xl flex flex-col items-center gap-1 border-b-4 border-blue-300">
                <i class="fas fa-broom text-2xl text-blue-600"></i>
                <span class="font-bold text-blue-800">ì²­ì†Œí•˜ê¸°</span>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="goToQuizSelect()"
                    class="game-btn bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-xl border-b-4 border-green-700">
                <i class="fas fa-book-open mb-1"></i> ê³µë¶€í•˜ê¸°
            </button>
            <button onclick="goToBattle()"
                    class="game-btn bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold text-xl border-b-4 border-red-700">
                <i class="fas fa-duel mb-1"></i> ë°°í‹€!
            </button>
        </div>
        <button onclick="goToCollection()"
                class="game-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold text-xl mt-3 border-b-4 border-indigo-700">
            <i class="fas fa-book mr-1"></i> ì¹œêµ¬ ë„ê°
        </button>
    </div>
</div>

<!-- âœ… ì˜ì–´ë†€ì´ ì œê±°: ìˆ«ì / í•œê¸€ë§Œ ë‚¨ê¹€ -->
<div id="quiz-select-screen"
     class="screen bg-gradient-to-b from-green-100 to-green-50 items-center justify-center p-6">
    <div class="w-full max-w-sm">
        <h2 class="text-3xl font-bold mb-6 text-center text-green-700">ê³µë¶€í•  ê³¼ëª©ì„ ê³¨ë¼ìš”!</h2>
        <div class="grid gap-4">
            <button onclick="startQuiz('number')"
                    class="game-btn bg-blue-500 hover:bg-blue-600 text-white py-6 rounded-2xl text-2xl font-bold shadow-lg">
                <i class="fas fa-calculator mr-2"></i> ìˆ«ìë†€ì´
            </button>
            <button onclick="startQuiz('korean')"
                    class="game-btn bg-purple-500 hover:bg-purple-600 text-white py-6 rounded-2xl text-2xl font-bold shadow-lg">
                <i class="fas fa-language mr-2"></i> í•œê¸€ë†€ì´
            </button>
        </div>
        <button onclick="goHome()" class="mt-4 text-gray-500 text-lg">â¬… ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<div id="quiz-screen"
     class="screen bg-gradient-to-b from-yellow-100 to-yellow-50 relative">
    <div class="bg-white p-3 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-3 flex-wrap">
            <span id="quiz-combo"
                  class="bg-green-500 text-white px-3 py-1 rounded-lg font-bold">ì—°ì†: 0</span>
            <span id="quiz-score"
                  class="bg-blue-500 text-white px-3 py-1 rounded-lg font-bold">ì ìˆ˜: 0</span>
            <!-- â± ì‹œê°„ ì œí•œ í‘œì‹œ -->
            <span id="quiz-timer"
                  class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold">ë‚¨ì€ ì‹œê°„: 10ì´ˆ</span>
        </div>
        <button onclick="endQuiz()"
                class="bg-red-400 text-white px-3 py-1 rounded-lg font-bold">ëë‚´ê¸°
        </button>
    </div>
    <div class="flex-1 flex flex-col justify-center items-center p-6">
        <h3 id="quiz-question"
            class="text-3xl font-bold text-gray-800 mb-8 text-center bg-white p-6 rounded-2xl shadow-lg border-4 border-yellow-300 min-w-[200px]">
            ë¬¸ì œ ì¤€ë¹„ ì¤‘...
        </h3>
        <div id="quiz-answers" class="w-full max-w-md grid grid-cols-2 gap-4">
        </div>
    </div>
</div>

<div id="battle-screen" class="screen bg-gradient-to-b from-red-100 to-orange-100 relative">
    <div class="bg-white p-3 flex justify-between items-center shadow-md z-10">
        <span class="text-lg font-bold text-red-700">âš”ï¸ ë°°í‹€ âš”ï¸</span>
        <button onclick="skipBattle()"
                class="bg-yellow-500 text-white px-3 py-1 rounded-lg font-bold text-sm">ê±´ë„ˆë›°ê¸°
        </button>
    </div>
    <div class="flex-1 p-4 flex flex-col justify-between">
        <div class="text-center">
            <div id="enemy-name" class="font-bold text-lg mb-2 text-red-700">ìƒëŒ€í¸</div>
            <div class="bar-container h-5 mb-2">
                <div id="enemy-hp-bar" class="bg-red-400 h-full transition-all duration-500"
                     style="width: 100%"></div>
            </div>
            <img id="enemy-pet-img" src=""
                 onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f47e.png'; this.style.width='100px';"
                 class="w-32 h-32 mx-auto object-contain" style="transition: all 0.2s">
        </div>
        <div id="battle-message"
             class="text-center text-2xl font-bold text-yellow-600 my-4"
             style="opacity:0; transition: opacity 0.3s">ì „íˆ¬ ì‹œì‘!
        </div>
        <div class="text-center">
            <img id="my-battle-img" src=""
                 onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png'; this.style.width='100px';"
                 class="w-32 h-32 mx-auto object-contain mb-2" style="transition: all 0.2s">
            <div class="bar-container h-5 mb-2">
                <div id="my-hp-bar" class="bg-green-400 h-full transition-all duration-500"
                     style="width: 100%"></div>
            </div>
            <div id="my-battle-name" class="font-bold text-lg text-blue-700">ë‚´ í«</div>
        </div>
    </div>
    <div id="battle-result-screen"
         style="display:none"
         class="absolute inset-0 bg-black bg-opacity-75 flex-col items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 text-center shadow-2xl border-8 border-yellow-400">
            <h2 id="result-title" class="text-4xl font-bold mb-4"></h2>
            <div id="result-reward" class="text-xl mb-6"></div>
            <button onclick="finishBattle()"
                    class="game-btn bg-blue-500 text-white px-8 py-3 rounded-xl font-bold text-xl">í™•ì¸
            </button>
        </div>
    </div>
</div>

<div id="battle-select-screen"
     class="screen bg-gradient-to-b from-purple-100 to-pink-100 p-6">
    <div class="w-full max-w-sm mx-auto">
        <h2 class="text-3xl font-bold mb-6 text-center text-purple-700">ë°°í‹€í•˜ì! ğŸ’¥</h2>

        <button
                onclick="showMyQr()"
                class="game-btn w-full bg-purple-500 hover:bg-purple-600 text-white py-6 rounded-2xl text-2xl font-bold mb-4 border-b-4 border-purple-700">
            <i class="fas fa-qrcode mr-2"></i> ë‚´ QR ë³´ì—¬ì£¼ê¸°
        </button>

        <button
                onclick="document.getElementById('qr-file-input').click()"
                class="game-btn w-full bg-pink-500 hover:bg-pink-600 text-white py-6 rounded-2xl text-2xl font-bold mb-4 border-b-4 border-pink-700">
            <i class="fas fa-camera mr-2"></i> QR ìŠ¤ìº”í•˜ê¸°
        </button>

        <!-- âœ… ëª¨ë°”ì¼ì—ì„œ í•­ìƒ ì¹´ë©”ë¼(ì‚¬ì§„ ì°ê¸°)ë¡œ ì—´ë¦¬ë„ë¡ capture ì†ì„± ì¶”ê°€ -->
        <input type="file"
               id="qr-file-input"
               accept="image/*"
               capture="environment"
               onchange="scanQRFromFile(event)">

        <button onclick="goHome()" class="mt-4 text-gray-500 text-lg block text-center">â¬… ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<!-- VS ì¤€ë¹„ í™”ë©´ -->
<div id="battle-ready-screen" class="screen bg-gradient-to-b from-red-50 to-yellow-50 p-6">
    <div class="w-full max-w-md mx-auto flex flex-col items-center gap-4">
        <h2 class="text-3xl font-bold text-red-600 mb-1">VS ì¤€ë¹„!</h2>
        <p class="text-sm text-gray-700 text-center mb-2">
            ì•„ë˜ ì¹œêµ¬ì™€ ëŒ€ê²°í• ê¹Œìš”?<br>ì¤€ë¹„ê°€ ë˜ë©´ <span class="font-bold">"ì‹¸ìš´ë‹¤!"</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ìš”.
        </p>
        <div class="w-full bg-white rounded-2xl shadow-lg p-4 flex items-center justify-between">
            <div class="flex flex-col items-center w-1/3">
                <img id="ready-my-img"
                     src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f436.png"
                     class="w-16 h-16 object-contain mb-1 pixel-art"
                     alt="ë‚´ í«">
                <div id="ready-my-name" class="font-bold text-blue-700 text-sm">ë‚˜</div>
                <div id="ready-my-level" class="text-xs text-gray-500">Lv.1</div>
            </div>
            <div class="text-3xl font-extrabold text-red-500">VS</div>
            <div class="flex flex-col items-center w-1/3">
                <img id="ready-enemy-img"
                     src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png"
                     class="w-16 h-16 object-contain mb-1 pixel-art"
                     alt="ìƒëŒ€ í«">
                <div id="ready-enemy-name" class="font-bold text-red-700 text-sm">ì¹œêµ¬</div>
                <div id="ready-enemy-level" class="text-xs text-gray-500">Lv.1</div>
            </div>
        </div>

        <button
                onclick="startBattleFromReady()"
                class="game-btn w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-2xl text-2xl font-bold border-b-4 border-red-700 mt-2">
            âš”ï¸ ì‹¸ìš´ë‹¤!
        </button>
        <button onclick="cancelBattleFromReady()" class="mt-2 text-gray-600 text-sm">
            ëŒì•„ê°€ê¸°
        </button>
    </div>
</div>
<!-- VS ì¤€ë¹„ í™”ë©´ ë -->

<div id="collection-screen"
     class="screen bg-gradient-to-b from-indigo-100 to-indigo-50 flex-col">
    <div class="bg-white p-3 flex items-center shadow-md">
        <button onclick="goHome()" class="text-gray-500 mr-3 text-2xl">â¬…</button>
        <h2 class="text-2xl font-bold text-indigo-700">ë‚˜ì˜ ì¹œêµ¬ ë„ê°</h2>
    </div>
    <div class="flex-1 overflow-auto p-4">
        <div id="collection-list" class="grid grid-cols-2 gap-3">
        </div>
    </div>
</div>

<script>
    /* --- ê²Œì„ ì „ì—­ ìƒíƒœ ë° ì´ˆê¸°í™” --- */
    let gameState = {
        player: {
            number: 0,
            name: "",
            level: 1,
            exp: 0,
            maxExp: 20,
            maxHp: 30,
            attack: 5,
            hunger: 100,
            cleanliness: 100,
            poops: 0,
            candies: 5,
            characterId: '00'
        },
        quiz: {
            type: 'number',
            score: 0,
            combo: 0,
            currentQuestion: null
        },
        collection: [],
        lastTickTime: Date.now()
    };

    const LEVEL_EXP_BASE = 20;
    const LEVEL_EXP_INC = 5;

    // â± í€´ì¦ˆ íƒ€ì´ë¨¸ ì„¤ì • (ì§ˆë¬¸ë‹¹ 10ì´ˆ)
    const QUIZ_TIME_LIMIT = 10; // ì´ˆ
    let quizTimeLeft = QUIZ_TIME_LIMIT;
    let quizTimerId = null;

    // í•œê¸€ í€´ì¦ˆ ë¡œì»¬ JSON í’€
    let koreanQuizPool = [];
    let koreanQuizLoaded = false;

    // QRì— ë„£ì–´ì¤„ ë°°í¬ í˜ì´ì§€ ì£¼ì†Œ
    const BASE_PAGE_URL = "https://anjaehyeong0619-bot.github.io/Frends/FrendsV2.html";

    // URL ì¿¼ë¦¬ë¡œë¶€í„° ì½ì–´ì˜¨ "ì " ì •ë³´ (enemyNumberìš©)
    let enemyFromUrl = null;

    function initEnemyFromUrl() {
        try {
            const params = new URLSearchParams(window.location.search);
            const numStr =
                params.get("enemyNumber") ||
                params.get("number") ||
                params.get("n");

            if (!numStr) return;

            const num = Number(numStr);
            if (!num || num <= 0) return;

            const name =
                params.get("enemyName") ||
                params.get("name") ||
                `ì¹œêµ¬ ${num}`;

            const level =
                Number(params.get("enemyLevel") || params.get("level")) ||
                1;

            enemyFromUrl = {number: num, name, level};
            console.log("[URL ENEMY (enemyNumber)]", enemyFromUrl);
        } catch (e) {
            console.warn("initEnemyFromUrl error", e);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì „ì— í•œ ë²ˆ URL ë¶„ì„
    initEnemyFromUrl();

    // VS ì¤€ë¹„ í™”ë©´ì—ì„œ ì‚¬ìš©í•  ì  ë°ì´í„°
    let battleState = {
        me: null,
        enemy: null,
        turn: 0,
        plan: [],
        isWin: false
    };

    let pendingEnemyData = null; // VS ì¤€ë¹„ìš©ìœ¼ë¡œ ë³´ê´€í•˜ëŠ” ì  ì •ë³´

    function initGame() {
        const saved = localStorage.getItem('myPetSchoolDataV3');
        if (saved) {
            try {
                gameState = JSON.parse(saved);
            } catch {
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ
            }
        }

        // quiz êµ¬ì¡° ë³´ì •
        if (!gameState.quiz) {
            gameState.quiz = {
                type: 'number',
                score: 0,
                combo: 0,
                currentQuestion: null
            };
        }

        if (gameState.player && gameState.player.name) {
            showScreen('main-screen');
            updateUI();
            startHungerTimer();
        } else {
            showScreen('start-screen');
        }

        // URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ìë™ ë°°í‹€ ì‹œì‘(= VS ì¤€ë¹„ ì§„ì…)
        checkURLForBattle();
    }

    function startGame() {
        const num = parseInt(document.getElementById('student-number').value);
        const name = document.getElementById('pet-name').value.trim();
        if (!num || !name) {
            alert('ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }
        gameState.player.number = num;
        gameState.player.name = name;
        saveGame();
        showScreen('main-screen');
        updateUI();
        startHungerTimer();

        // ê²Œì„ ì‹œì‘ í›„ì—ë„ URL íŒŒë¼ë¯¸í„°/ëŒ€ê¸° ì¤‘ ë°°í‹€ í™•ì¸
        checkURLForBattle();
    }

    function saveGame() {
        localStorage.setItem('myPetSchoolDataV3', JSON.stringify(gameState));
    }

    /* --- URL íŒŒë¼ë¯¸í„°ë¡œ ìë™ ë°°í‹€ ì¤€ë¹„ --- */
    function checkURLForBattle() {
        const urlParams = new URLSearchParams(window.location.search);
        const battleData = urlParams.get('battle');
        let enemyData = null;

        if (battleData) {
            try {
                const decodedData = atob(battleData);
                enemyData = JSON.parse(decodedData);
                console.log('[URL ENEMY (battle)]', enemyData);
            } catch (e) {
                console.error('ë°°í‹€ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨(battle):', e);
            }
        } else if (enemyFromUrl) {
            // enemyNumber=... ë°©ì‹ë„ ì§€ì›
            enemyData = enemyFromUrl;
            console.log('[URL ENEMY (enemyNumber ì‚¬ìš©)]', enemyData);
        }

        // ì§€ê¸ˆ ë°”ë¡œ VS ì¤€ë¹„ë¡œ ê°ˆ ìˆ˜ ìˆëŠ”ì§€ ì²´í¬
        if (enemyData) {
            if (!gameState.player || !gameState.player.name) {
                // ë‚´ í« ì •ë³´ê°€ ì—†ìœ¼ë©´, ì¼ë‹¨ battle íŒŒë¼ë¯¸í„°(or enemyData)ë¥¼ ì„¸ì…˜ì— ì €ì¥í•´ ë‘ê³ 
                // ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ í›„ ë‹¤ì‹œ checkURLForBattle()ì—ì„œ ì²˜ë¦¬
                try {
                    const encoded = battleData || btoa(JSON.stringify(enemyData));
                    sessionStorage.setItem('pendingBattle', encoded);
                } catch (e) {
                    console.error('pendingBattle ì €ì¥ ì‹¤íŒ¨:', e);
                }
                return;
            }

            // ë‚´ í« ì •ë³´ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê³§ë°”ë¡œ VS ì¤€ë¹„ í™”ë©´ìœ¼ë¡œ
            startBattleFromData(enemyData);

            // ìƒˆë¡œê³ ì¹¨ ì‹œ ë°˜ë³µ ì‹¤í–‰ ë°©ì§€
            window.history.replaceState({}, document.title, window.location.pathname);
            return;
        }

        // ìŒ“ì—¬ìˆë˜ pendingBattle ì²˜ë¦¬ (ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ í›„)
        const pendingBattle = sessionStorage.getItem('pendingBattle');
        if (pendingBattle && gameState.player && gameState.player.name) {
            try {
                const decodedData = atob(pendingBattle);
                const enemy = JSON.parse(decodedData);
                startBattleFromData(enemy);
                sessionStorage.removeItem('pendingBattle');
            } catch (e) {
                console.error('ëŒ€ê¸° ì¤‘ ë°°í‹€ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
            }
        }
    }

    // VS ì¤€ë¹„ í™”ë©´ìœ¼ë¡œ ì§„ì…ì‹œí‚¤ëŠ” í•¨ìˆ˜
    function startBattleFromData(enemyData) {
        pendingEnemyData = enemyData;
        showBattleReadyScreen();
    }

    /* --- ë©”ì¸í™”ë©´ ë° UI ì—…ë°ì´íŠ¸ --- */
    function updateUI() {
        const p = gameState.player;
        if (!p) return;

        document.getElementById('ui-name').innerText = p.name || '';
        document.getElementById('ui-level').innerText = p.level ?? 1;
        document.getElementById('ui-candy').innerText = p.candies ?? 0;
        document.getElementById('ui-exp-text').innerText = `${p.exp ?? 0}/${p.maxExp ?? 20}`;

        const expRatio = (p.exp ?? 0) / (p.maxExp || 20);
        document.getElementById('ui-exp-bar').style.width = `${Math.min(100, Math.max(0, expRatio * 100))}%`;

        document.getElementById('ui-hunger-bar').style.width = `${Math.max(0, Math.min(100, p.hunger ?? 0))}%`;
        document.getElementById('ui-clean-bar').style.width = `${Math.max(0, Math.min(100, p.cleanliness ?? 0))}%`;

        const imgNumber = (p.number || 0).toString().padStart(2, "0");
        const petImg = document.getElementById('pet-image');
        petImg.src = `./png/${imgNumber}.png`;
        petImg.style.width = '200px';
        petImg.style.height = '200px';

        const bubble = document.getElementById('pet-bubble');
        if (p.hunger < 30) {
            bubble.innerText = "ë°°ê³ íŒŒìš”...";
            bubble.style.opacity = 1;
        } else if (p.cleanliness < 30) {
            bubble.innerText = "ì”»ê³  ì‹¶ì–´ìš”...";
            bubble.style.opacity = 1;
        } else {
            bubble.style.opacity = 0;
        }
    }

    function startHungerTimer() {
        setInterval(() => {
            if (!gameState.player) return;
            gameState.player.hunger = Math.max(0, (gameState.player.hunger ?? 0) - 1);
            updateUI();
            saveGame();
        }, 5000);

        setInterval(() => {
            if (!gameState.player) return;
            if (Math.random() < 0.3 && (gameState.poopCount ?? 0) < 3) {
                createPoop();
            }
        }, 10000);
    }

    function feedPet() {
        const p = gameState.player;
        if (!p) return;

        if (p.candies < 3) {
            alert("ì‚¬íƒ•ì´ ë¶€ì¡±í•´ìš”! ê³µë¶€í•´ì„œ ì‚¬íƒ•ì„ ëª¨ì•„ìš”.");
            return;
        }
        p.candies -= 3;
        p.hunger = Math.min(100, (p.hunger ?? 0) + 30);
        addExp(5);
        saveGame();
        updateUI();
    }

    function createPoop() {
        const container = document.getElementById('poop-container');
        const poop = document.createElement('div');
        poop.className = 'poop';
        poop.innerText = 'ğŸ’©';
        poop.style.left = Math.random() * 80 + '%';
        poop.style.top = Math.random() * 80 + '%';
        poop.onclick = () => {
            poop.remove();
            gameState.poopCount--;
            gameState.player.cleanliness = Math.min(100, (gameState.player.cleanliness ?? 0) + 10);
            addExp(2);
            updateUI();
            saveGame();
        };
        container.appendChild(poop);
        gameState.poopCount = (gameState.poopCount ?? 0) + 1;
        gameState.player.cleanliness = Math.max(0, (gameState.player.cleanliness ?? 0) - 20);
        updateUI();
        saveGame();
    }

    function cleanPoop() {
        const poops = document.querySelectorAll('.poop');
        if (poops.length === 0) {
            alert("ê¹¨ë—í•´ìš”!");
            return;
        }
        poops.forEach(p => p.remove());
        gameState.poopCount = 0;
        gameState.player.cleanliness = 100;
        addExp(5);
        updateUI();
        saveGame();
    }

    function addExp(amount) {
        const p = gameState.player;
        if (!p) return;

        p.exp = (p.exp ?? 0) + amount;
        p.maxExp = p.maxExp || LEVEL_EXP_BASE;

        while (p.exp >= p.maxExp) {
            p.exp -= p.maxExp;
            p.level = (p.level ?? 1) + 1;
            p.maxExp = Math.floor(p.maxExp * 1.5);
            alert(`ğŸ‰ ë ˆë²¨ì—…! Lv.${p.level}`);
        }
        saveGame();
        updateUI();
    }

    /* --- í€´ì¦ˆ íƒ€ì´ë¨¸ ìœ í‹¸ --- */

    function updateQuizTimerUI() {
        const el = document.getElementById('quiz-timer');
        if (!el) return;
        el.innerText = `ë‚¨ì€ ì‹œê°„: ${quizTimeLeft}ì´ˆ`;
        if (quizTimeLeft <= 3) {
            el.classList.add('bg-red-700');
        } else {
            el.classList.remove('bg-red-700');
        }
    }

    function clearQuizTimer() {
        if (quizTimerId) {
            clearInterval(quizTimerId);
            quizTimerId = null;
        }
    }

    function startQuizTimer() {
        clearQuizTimer();
        quizTimeLeft = QUIZ_TIME_LIMIT;
        updateQuizTimerUI();
        quizTimerId = setInterval(() => {
            quizTimeLeft--;
            updateQuizTimerUI();
            if (quizTimeLeft <= 0) {
                clearQuizTimer();
                handleTimeUp();
            }
        }, 1000);
    }

    function handleTimeUp() {
        // ì‹œê°„ ì´ˆê³¼: ì˜¤ë‹µ ì²˜ë¦¬ + ì½¤ë³´ ì´ˆê¸°í™” í›„ ë‹¤ìŒ ë¬¸ì œ
        gameState.quiz.combo = 0;
        alert('ì‹œê°„ ì´ˆê³¼! ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ìš”.');
        const comboEl = document.getElementById('quiz-combo');
        if (comboEl) {
            comboEl.innerText = `ì—°ì†: ${gameState.quiz.combo}`;
        }
        saveGame();
        generateQuestion();
    }

    /* --- í•œê¸€ í€´ì¦ˆ ë¡œì»¬ JSON ë¡œë” --- */
    async function loadKoreanQuiz() {
        if (koreanQuizLoaded) return;
        try {
            const res = await fetch("./quiz/Koquiz.json", {cache: "no-store"});
            const data = await res.json();
            let list;
            if (Array.isArray(data)) {
                list = data;
            } else if (Array.isArray(data.questions)) {
                list = data.questions;
            } else if (Array.isArray(data.quiz)) {
                list = data.quiz;
            } else {
                list = [];
            }
            koreanQuizPool = list;
            koreanQuizLoaded = true;
            console.log("Koquiz.json ë¡œë“œ ì™„ë£Œ:", koreanQuizPool.length);
        } catch (e) {
            console.error("Koquiz.json ë¡œë“œ ì‹¤íŒ¨:", e);
            koreanQuizPool = [];
            koreanQuizLoaded = true;
        }
    }

    /* --- í€´ì¦ˆ ì‹œìŠ¤í…œ --- */
    function goToQuizSelect() {
        clearQuizTimer();
        showScreen('quiz-select-screen');
    }

    function startQuiz(type) {
        // ì•ˆì „ì¥ì¹˜: number / korean ë§Œ í—ˆìš©
        if (type !== 'number' && type !== 'korean') {
            type = 'number';
        }
        gameState.quiz.type = type;
        gameState.quiz.score = 0;
        gameState.quiz.combo = 0;
        showScreen('quiz-screen');
        document.getElementById('quiz-score').innerText = `ì ìˆ˜: 0`;
        document.getElementById('quiz-combo').innerText = `ì—°ì†: 0`;
        generateQuestion();
    }

    // âœ… generateQuestionë¥¼ asyncë¡œ ë³€ê²½ (í•œê¸€ í€´ì¦ˆ ë¡œë”© ì§€ì›)
    async function generateQuestion() {
        const type = gameState.quiz.type;
        let question, correctAnswer, wrongAnswers;

        if (type === 'number') {
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            const op = Math.random() > 0.5 ? '+' : '-';
            if (op === '+') {
                question = `${a} + ${b} = ?`;
                correctAnswer = a + b;
            } else {
                question = `${Math.max(a, b)} - ${Math.min(a, b)} = ?`;
                correctAnswer = Math.max(a, b) - Math.min(a, b);
            }
            wrongAnswers = [];
            while (wrongAnswers.length < 3) {
                const wrong = correctAnswer + Math.floor(Math.random() * 10) - 5;
                if (wrong !== correctAnswer && wrong >= 0 && !wrongAnswers.includes(wrong)) {
                    wrongAnswers.push(wrong);
                }
            }
        } else if (type === 'korean') {
            // ë¡œì»¬ JSONì—ì„œ í•œê¸€ ë¬¸ì œ ë¡œë“œ
            if (!koreanQuizLoaded) {
                await loadKoreanQuiz();
            }
            if (koreanQuizPool && koreanQuizPool.length > 0) {
                const idx = Math.floor(Math.random() * koreanQuizPool.length);
                const item = koreanQuizPool[idx];

                // ê¸°ë³¸ í¬ë§· ê°€ì •:
                // { question: "ë¬¸ì œ", choices: ["ë³´ê¸°1","ë³´ê¸°2","ë³´ê¸°3","ë³´ê¸°4"], answerIndex: 0 }
                const qText = item.question || item.q || "";
                const choices = item.choices || item.options || [];
                let answerIndex =
                    (typeof item.answerIndex === "number" ? item.answerIndex :
                        (typeof item.correctIndex === "number" ? item.correctIndex : 0));

                if (Array.isArray(choices) && choices.length >= 2) {
                    if (answerIndex < 0 || answerIndex >= choices.length) {
                        answerIndex = 0;
                    }
                    question = qText || "ë‹¤ìŒ ì¤‘ ì•Œë§ì€ ê²ƒì„ ê³ ë¥´ì„¸ìš”.";
                    correctAnswer = choices[answerIndex];
                    wrongAnswers = choices.filter((_, i) => i !== answerIndex);
                }
            }

            // í˜¹ì‹œ JSONì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•Šìœ¼ë©´ ê°„ë‹¨í•œ ì˜ˆë¹„ ë¬¸ì œ ì‚¬ìš©
            if (!question) {
                const words = [
                    {q: 'ê°€ë°©', c: 'ê°€ë°©', w: ['ê°€ë¹µ', 'ê°€ë°©ì´', 'ê°€ë±¡']},
                    {q: 'í•™êµ', c: 'í•™êµ', w: ['í•™ê¾œ', 'í•˜êµ', 'í•™êµ£']},
                    {q: 'ì¹œêµ¬', c: 'ì¹œêµ¬', w: ['ì¹Ÿêµ¬', 'ì¹­êµ¬', 'ì¹œêµ¬ê°€']},
                    {q: 'ì—°í•„', c: 'ì—°í•„', w: ['ì—°í•„ì´', 'ë…„í•„', 'ì—°í•„ã…']},
                    {q: 'ì§€ìš°ê°œ', c: 'ì§€ìš°ê°œ', w: ['ì§€ìš°ê²Œ', 'ì§€ìš°ê°œê°€', 'ì§€ìš°ìº¬']}
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                question = `ë°”ë¥´ê²Œ ì“´ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?\n(ì½ì–´ ë³´ê³  ê³¨ë¼ìš”)`;
                correctAnswer = item.c;
                wrongAnswers = item.w;
            }
        } else {
            // ë°©ì–´ ì½”ë“œ: ì´ìƒí•œ íƒ€ì…ì´ë©´ ìˆ«ì ë¬¸ì œë¡œ fallback
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            question = `${a} + ${b} = ?`;
            correctAnswer = a + b;
            wrongAnswers = [a + b + 1, a + b - 1, a + b + 2];
        }

        gameState.quiz.currentQuestion = {question, correctAnswer};
        displayQuestion(question, correctAnswer, wrongAnswers);
    }

    function displayQuestion(question, correct, wrongs) {
        document.getElementById('quiz-question').innerText = question;
        const answersEl = document.getElementById('quiz-answers');
        answersEl.innerHTML = '';

        const allAnswers = [correct, ...wrongs].sort(() => Math.random() - 0.5);
        allAnswers.forEach(ans => {
            const btn = document.createElement('button');
            btn.className = 'game-btn bg-blue-200 hover:bg-blue-300 p-6 rounded-xl text-2xl font-bold border-b-4 border-blue-400';
            btn.innerText = ans;
            btn.onclick = () => checkAnswer(ans);
            answersEl.appendChild(btn);
        });

        // â—ê° ë¬¸ì œ í‘œì‹œë§ˆë‹¤ íƒ€ì´ë¨¸ ì‹œì‘
        startQuizTimer();
    }

    function checkAnswer(answer) {
        clearQuizTimer(); // ë‹µì„ ëˆ„ë¥´ë©´ íƒ€ì´ë¨¸ ì •ì§€

        const correct = gameState.quiz.currentQuestion.correctAnswer;
        const isCorrect = answer == correct;

        if (isCorrect) {
            gameState.quiz.score += 10;
            gameState.quiz.combo++;
            gameState.player.candies += 1;
            addExp(3);

            if (gameState.quiz.combo > 1 && gameState.quiz.combo % 3 === 0) {
                showComboEffect(gameState.quiz.combo);
                gameState.player.candies += 2;
            }
        } else {
            gameState.quiz.combo = 0;
            alert('ì•„ê¹ë„¤ìš”! ë‹¤ì‹œ ë„ì „í•´ìš”.');
        }

        document.getElementById('quiz-score').innerText = `ì ìˆ˜: ${gameState.quiz.score}`;
        document.getElementById('quiz-combo').innerText = `ì—°ì†: ${gameState.quiz.combo}`;
        saveGame();
        generateQuestion();
    }

    function showComboEffect(combo) {
        const el = document.createElement('div');
        el.className = 'combo-text';
        el.innerText = `${combo} COMBO! +2 ì‚¬íƒ•`;
        el.style.left = '50%';
        el.style.top = '50%';
        el.style.transform = 'translate(-50%, -50%)';
        document.getElementById('quiz-screen').appendChild(el);
        setTimeout(() => el.remove(), 500);
    }

    function endQuiz() {
        clearQuizTimer();
        alert(`í€´ì¦ˆ ë! ì ìˆ˜: ${gameState.quiz.score}, ì‚¬íƒ•ì„ ëª¨ì•˜ì–´ìš”!`);
        goHome();
    }

    /* --- ë°°í‹€ ì‹œìŠ¤í…œ --- */
    function goToBattle() {
        showScreen('battle-select-screen');
    }

    // âœ… QR ìƒì„±: enemyNumber / enemyName / enemyLevel ë¡œ URL ìƒì„±
    function showMyQr() {
        // 1) í”Œë ˆì´ì–´ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
        if (!gameState.player || !gameState.player.name) {
            alert("ë¨¼ì € ë²ˆí˜¸ì™€ í« ì´ë¦„ì„ ì…ë ¥í•´ì„œ ê²Œì„ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”!");
            return;
        }

        const myData = {
            name: gameState.player.name,
            level: gameState.player.level,
            number: gameState.player.number
        };

        const params = new URLSearchParams({
            enemyNumber: String(myData.number),
            enemyName: myData.name,
            enemyLevel: String(myData.level)
        });

        const battleUrl = `${BASE_PAGE_URL}?${params.toString()}`;
        console.log("[MY QR URL]", battleUrl);

        const modal = document.getElementById('my-qr-modal');
        if (!modal) {
            alert("QR ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš” (my-qr-modal). HTML êµ¬ì¡°ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            return;
        }
        modal.classList.remove('hidden');

        const qrBox = document.getElementById('my-qr-box');
        if (!qrBox) {
            alert("QR ë°•ìŠ¤(my-qr-box)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.");
            return;
        }
        qrBox.innerHTML = '';

        try {
            if (typeof QRCode === "undefined") {
                console.error("QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                qrBox.innerHTML = `<div class="text-xs break-words">${battleUrl}</div>`;
            } else {
                new QRCode(qrBox, {
                    text: battleUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });
            }
        } catch (e) {
            console.error("QR ìƒì„± ì¤‘ ì˜¤ë¥˜:", e);
            qrBox.innerHTML = `<div class="text-xs break-words">${battleUrl}</div>`;
        }

        const textEl = document.getElementById('my-qr-text');
        if (textEl) {
            textEl.innerText = `Lv.${myData.level} ${myData.name}`;
        }
    }

    function closeMyQrModal() {
        document.getElementById('my-qr-modal').classList.add('hidden');
    }

    // âœ… QR ìŠ¤ìº” ì‹œ í•­ìƒ ì¹´ë©”ë¼ ì‚¬ì§„ â†’ jsQR
    function scanQRFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    scanBattle(code.data);
                } else {
                    alert('QR ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        // ë‹¤ìŒ ìŠ¤ìº” ë•Œë„ ì¹´ë©”ë¼ê°€ ë°”ë¡œ ì—´ë¦¬ë„ë¡ value ì´ˆê¸°í™”
        event.target.value = "";
    }

    // âœ… QR ë‚´ìš©: URL(battle=..., enemyNumber=...) ë˜ëŠ” JSON ëª¨ë‘ ì§€ì›
    function scanBattle(data) {
        try {
            let enemyData = null;

            // ìš°ì„  URLë¡œ íŒŒì‹± ì‹œë„
            try {
                const url = new URL(data);
                const battleParam = url.searchParams.get('battle');
                if (battleParam) {
                    const decodedData = atob(battleParam);
                    enemyData = JSON.parse(decodedData);
                } else {
                    const numStr = url.searchParams.get("enemyNumber") || url.searchParams.get("number");
                    if (numStr) {
                        const num = Number(numStr);
                        const name =
                            url.searchParams.get("enemyName") ||
                            url.searchParams.get("name") ||
                            `ì¹œêµ¬ ${num}`;
                        const level =
                            Number(url.searchParams.get("enemyLevel") || url.searchParams.get("level")) || 1;
                        enemyData = {number: num, name, level};
                    }
                }
            } catch (e) {
                // dataê°€ URLì´ ì•„ë‹ ìˆ˜ë„ ìˆìŒ â†’ ë¬´ì‹œ
            }

            // URLì—ì„œ ëª» ì½ì—ˆìœ¼ë©´ JSON ì§ì ‘ íŒŒì‹± ì‹œë„
            if (!enemyData) {
                enemyData = JSON.parse(data);
            }

            startBattleFromData(enemyData);
        } catch (e) {
            alert('ì˜¬ë°”ë¥¸ QR ì½”ë“œê°€ ì•„ë‹ˆì—ìš”!');
            console.error(e);
        }
    }

    /* --- ë°°í‹€ ë¡œì§ --- */
    function startBattle(enemyData) {
        const myHp = 50 + gameState.player.level * 10;
        const enemyHp = 50 + enemyData.level * 10;

        battleState.me = {
            name: gameState.player.name,
            level: gameState.player.level,
            maxHp: myHp,
            attack: 5 + gameState.player.level * 2
        };

        battleState.enemy = {
            name: enemyData.name,
            level: enemyData.level,
            number: enemyData.number,
            maxHp: enemyHp,
            attack: 5 + enemyData.level * 2
        };

        battleState.turn = 0;
        battleState.isWin = Math.random() > 0.5;
        battleState.plan = generateBattlePlan();

        document.getElementById('my-battle-name').innerText = battleState.me.name;
        document.getElementById('enemy-name').innerText =
            `${battleState.enemy.name} (Lv.${battleState.enemy.level})`;

        const myImgNum = (gameState.player.number || 0).toString().padStart(2, "0");
        const enemyImgNum = (enemyData.number || 0).toString().padStart(2, "0");

        const myImg = document.getElementById('my-battle-img');
        myImg.src = `./png/${myImgNum}.png`;
        myImg.style.width = '120px';
        myImg.style.height = '120px';

        const enemyImg = document.getElementById('enemy-pet-img');
        enemyImg.src = `./png/${enemyImgNum}.png`;
        enemyImg.style.width = '120px';
        enemyImg.style.height = '120px';

        updateHpBars(battleState.me.maxHp, battleState.me.maxHp, battleState.enemy.maxHp, battleState.enemy.maxHp);

        setTimeout(playNextTurn, 1000);
    }

    function generateBattlePlan() {
        const dmgToEnemyPerTurn = 3 + Math.floor(Math.random() * 5);
        const dmgToMePerTurn = 3 + Math.floor(Math.random() * 5);
        const iWin = battleState.isWin;
        const winnerTotalDmg = iWin ? battleState.enemy.maxHp : battleState.me.maxHp;
        const loserTotalDmg = Math.floor(winnerTotalDmg * 0.3 + Math.random() * winnerTotalDmg * 0.4);
        const turns = 6 + Math.floor(Math.random() * 4);
        const plan = [];
        let currentMyHp = battleState.me.maxHp;
        let currentEnemyHp = battleState.enemy.maxHp;
        let isMyTurn = true;

        for (let i = 0; i < turns; i++) {
            if (isMyTurn) {
                let dmg = dmgToEnemyPerTurn + Math.floor(Math.random() * 2);
                if (currentEnemyHp - dmg < 0) dmg = currentEnemyHp;
                if (i === turns - 1 && iWin) dmg = currentEnemyHp;
                currentEnemyHp -= dmg;
                plan.push({
                    attacker: 'me',
                    damage: dmg,
                    remainingEnemyHp: currentEnemyHp,
                    remainingMyHp: currentMyHp
                });
            } else {
                let dmg = dmgToMePerTurn + Math.floor(Math.random() * 2);
                if (currentMyHp - dmg < 0) dmg = currentMyHp;
                if (i === turns - 1 && !iWin) dmg = currentMyHp;
                currentMyHp -= dmg;
                plan.push({
                    attacker: 'enemy',
                    damage: dmg,
                    remainingEnemyHp: currentEnemyHp,
                    remainingMyHp: currentMyHp
                });
            }
            isMyTurn = !isMyTurn;
            if (currentEnemyHp <= 0 || currentMyHp <= 0) break;
        }
        return plan;
    }

    function playNextTurn() {
        if (battleState.turn >= battleState.plan.length) {
            showBattleResult();
            return;
        }

        const action = battleState.plan[battleState.turn];
        const msgEl = document.getElementById('battle-message');
        const myImg = document.getElementById('my-battle-img');
        const enemyImg = document.getElementById('enemy-pet-img');

        if (action.attacker === 'me') {
            msgEl.innerText = "ë‚˜ì˜ ê³µê²©!";
            myImg.style.transform = "translateX(50px) rotate(10deg)";
            setTimeout(() => myImg.style.transform = "translateX(0)", 200);
            setTimeout(() => {
                enemyImg.style.opacity = 0.5;
                setTimeout(() => enemyImg.style.opacity = 1, 100);
                updateHpBars(action.remainingMyHp, battleState.me.maxHp, action.remainingEnemyHp, battleState.enemy.maxHp);
                showDamage(action.damage, 'enemy');
            }, 200);
        } else {
            msgEl.innerText = `${battleState.enemy.name}ì˜ ê³µê²©!`;
            enemyImg.style.transform = "translateX(-50px) rotate(-10deg)";
            setTimeout(() => enemyImg.style.transform = "translateX(0)", 200);
            setTimeout(() => {
                myImg.style.opacity = 0.5;
                setTimeout(() => myImg.style.opacity = 1, 100);
                updateHpBars(action.remainingMyHp, battleState.me.maxHp, action.remainingEnemyHp, battleState.enemy.maxHp);
                showDamage(action.damage, 'me');
            }, 200);
        }

        msgEl.style.opacity = 1;
        setTimeout(() => msgEl.style.opacity = 0, 800);
        battleState.turn++;
        setTimeout(playNextTurn, 1500);
    }

    function showDamage(amount, target) {
        const el = document.createElement('div');
        el.className = 'damage-text';
        el.innerText = `-${amount}`;
        if (target === 'enemy') {
            el.style.top = '20%';
            el.style.left = '50%';
        } else {
            el.style.bottom = '20%';
            el.style.left = '50%';
        }
        document.getElementById('battle-screen').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function updateHpBars(myCur, myMax, enCur, enMax) {
        document.getElementById('my-hp-bar').style.width = `${(myCur / myMax) * 100}%`;
        document.getElementById('enemy-hp-bar').style.width = `${(enCur / enMax) * 100}%`;
    }

    function skipBattle() {
        const last = battleState.plan[battleState.plan.length - 1];
        updateHpBars(last.remainingMyHp, battleState.me.maxHp, last.remainingEnemyHp, battleState.enemy.maxHp);
        battleState.turn = battleState.plan.length;
        setTimeout(showBattleResult, 500);
    }

    function showBattleResult() {
        const screen = document.getElementById('battle-result-screen');
        screen.style.display = 'flex';
        const title = document.getElementById('result-title');
        const reward = document.getElementById('result-reward');

        if (battleState.isWin) {
            title.innerText = "ìŠ¹ë¦¬!";
            title.style.color = "#FBBF24";
            reward.innerHTML = "<p>ì‚¬íƒ• +3ê°œ</p><p>ê²½í—˜ì¹˜ +10</p>";
            gameState.player.candies += 3;
            addExp(10);
            addToCollection(battleState.enemy);
        } else {
            title.innerText = "ì•„ì‰¬ì›Œìš”...";
            title.style.color = "#9CA3AF";
            reward.innerHTML = "<p>ìœ„ë¡œê¸ˆ: ì‚¬íƒ• +1ê°œ</p>";
            gameState.player.candies += 1;
        }
        saveGame();
    }

    function finishBattle() {
        document.getElementById('battle-result-screen').style.display = 'none';
        showScreen('main-screen');
        updateUI();
    }

    /* --- VS ì¤€ë¹„ í™”ë©´ ì œì–´ --- */
    function showBattleReadyScreen() {
        if (!pendingEnemyData || !gameState.player || !gameState.player.name) {
            goHome();
            return;
        }

        const p = gameState.player;
        const e = pendingEnemyData;

        const myImgNum = (p.number || 0).toString().padStart(2, "0");
        const enemyImgNum = (e.number || 0).toString().padStart(2, "0");

        const myImg = document.getElementById('ready-my-img');
        myImg.src = `./png/${myImgNum}.png`;

        const enemyImg = document.getElementById('ready-enemy-img');
        enemyImg.src = `./png/${enemyImgNum}.png`;

        document.getElementById('ready-my-name').innerText = p.name || 'ë‚˜';
        document.getElementById('ready-my-level').innerText = `Lv.${p.level ?? 1}`;

        document.getElementById('ready-enemy-name').innerText = e.name || 'ì¹œêµ¬';
        document.getElementById('ready-enemy-level').innerText = `Lv.${e.level ?? 1}`;

        showScreen('battle-ready-screen');
    }

    function startBattleFromReady() {
        if (!pendingEnemyData) {
            goHome();
            return;
        }
        const enemyData = pendingEnemyData;
        pendingEnemyData = null;

        showScreen('battle-screen');
        startBattle(enemyData);
    }

    function cancelBattleFromReady() {
        pendingEnemyData = null;
        goHome();
    }

    /* --- ë„ê° ì‹œìŠ¤í…œ --- */
    function addToCollection(enemy) {
        const exists = gameState.collection.find(c => c.name === enemy.name);
        if (!exists) {
            gameState.collection.push({
                name: enemy.name,
                level: enemy.level,
                number: enemy.number,
                date: new Date().toLocaleDateString()
            });
        }
    }

    function goToCollection() {
        showScreen('collection-screen');
        const list = document.getElementById('collection-list');
        list.innerHTML = '';

        if (gameState.collection.length === 0) {
            list.innerHTML =
                '<div class="col-span-2 text-center text-gray-400 mt-10">ì•„ì§ ë§Œë‚œ ì¹œêµ¬ê°€ ì—†ì–´ìš”.<br>ë°°í‹€ì„ í•´ì„œ ì¹œêµ¬ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!</div>';
            return;
        }

        gameState.collection.forEach(friend => {
            const el = document.createElement('div');
            el.className = "bg-white p-3 rounded-xl shadow border border-indigo-100 flex flex-col items-center";
            const imgId = (friend.number || 0).toString().padStart(2, "0");

            el.innerHTML = `
                <img src="./png/${imgId}.png"
                     onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f431.png'; this.style.width='60px';"
                     class="w-16 h-16 object-contain mb-2">
                <div class="font-bold text-indigo-900">${friend.name}</div>
                <div class="text-sm text-gray-500">Lv.${friend.level}</div>
            `;
            list.appendChild(el);
        });
    }

    /* --- ìœ í‹¸ë¦¬í‹° --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
        });
        const target = document.getElementById(id);
        if (!target) return;
        target.classList.add('active');
        target.style.display = 'flex';
    }

    function goHome() {
        if (gameState.player && gameState.player.name) {
            showScreen('main-screen');
            updateUI();
        } else {
            showScreen('start-screen');
        }
    }

    function openSettings() {
        if (confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ í• ê¹Œìš”? (ë°ì´í„°ê°€ ëª¨ë‘ ì§€ì›Œì ¸ìš”)')) {
            localStorage.removeItem('myPetSchoolDataV3');
            location.reload();
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì„ ì´ˆê¸°í™”
    window.onload = initGame;
</script>

<!-- ë‚´ í« QR ëª¨ë‹¬ -->
<div id="my-qr-modal"
     class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-4 w-72 text-center relative shadow-2xl border-4 border-purple-400">
        <button
                onclick="closeMyQrModal()"
                class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl leading-none">
            âœ•
        </button>
        <h3 class="text-xl font-bold mb-2 text-purple-700">ë‚´ í« QR</h3>
        <p class="text-xs text-gray-600 mb-2">
            ì¹œêµ¬ëŠ” ì´ QRì„ ì°ì–´ì„œ<br>ë‚˜ì™€ ë°°í‹€í•  ìˆ˜ ìˆì–´ìš”!
        </p>

        <div
                id="my-qr-box"
                class="bg-white p-2 rounded-xl flex items-center justify-center mb-2"
                style="min-height: 210px;"
        ></div>

        <div
                id="my-qr-text"
                class="text-[10px] text-gray-500 break-words bg-gray-100 rounded-lg p-1"
        ></div>
    </div>
</div>

</body>
</html>
